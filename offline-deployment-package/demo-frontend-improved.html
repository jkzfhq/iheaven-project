<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iHeaven 数字永生系统 - 改进版演示页面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .feature {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .controls-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 5px;
        }
        
        .button:hover {
            background: #5a6fd8;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.secondary:hover {
            background: #5a6268;
        }
        
        .response {
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .empty-state p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        /* 卡片网格布局 */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, rgba(102,126,234,0.1), transparent);
            border-radius: 0 0 0 50px;
        }

        .item-card.citizen {
            border-left-color: #28a745;
        }

        .item-card.pet {
            border-left-color: #fd7e14;
        }

        .item-card.collection {
            border-left-color: #6f42c1;
        }

        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-icon {
            font-size: 2rem;
            margin-right: 12px;
            padding: 8px;
            background: rgba(102,126,234,0.1);
            border-radius: 50%;
        }

        .item-icon.citizen {
            background: rgba(40,167,69,0.1);
        }

        .item-icon.pet {
            background: rgba(253,126,20,0.1);
        }

        .item-icon.collection {
            background: rgba(111,66,193,0.1);
        }

        .item-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .item-id {
            font-size: 0.75rem;
            color: #6c757d;
            font-family: 'Courier New', monospace;
            margin-top: 2px;
        }

        .item-meta {
            margin-bottom: 15px;
        }

        .meta-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .meta-icon {
            width: 16px;
            margin-right: 8px;
            color: #6c757d;
        }

        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .access-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .access-badge.public {
            background: #d4edda;
            color: #155724;
        }

        .access-badge.link {
            background: #fff3cd;
            color: #856404;
        }

        .access-badge.private {
            background: #f8d7da;
            color: #721c24;
        }

        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* P2P状态样式 */
        .p2p-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .p2p-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }

        .p2p-section h3 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #6c757d;
            font-weight: 500;
        }

        .status-value {
            font-weight: 600;
            color: #495057;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-starting {
            background: #fff3cd;
            color: #856404;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .node-id {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        @media (max-width: 768px) {
            .controls-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 新增：网络状态卡片样式 */
        .network-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .network-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #007bff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .network-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .network-card h3 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .network-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* 刷新信息样式 */
        .refresh-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .refresh-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .network-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #6c757d;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .metric-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .metric-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .metric-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .metric-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .metric-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* 进度条样式 */
        .progress-container {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #007bff, #0056b3);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.success {
            background: linear-gradient(90deg, #28a745, #1e7e34);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #ffc107, #e0a800);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌟 iHeaven 数字永生系统</h1>
            <p>永远保存珍贵的记忆，让爱永续传承</p>
        </div>

        <div class="card">
            <h2>🎯 系统介绍</h2>
            <p>iHeaven 是一个数字永生系统，旨在帮助用户永久保存重要的记忆和文档。通过先进的透明日志技术和见证人机制，确保您的数据安全可信，永不丢失。</p>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">👤</div>
                <h3>市民档案</h3>
                <p>保存人的生平记录、照片、文档等重要信息</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🐕</div>
                <h3>宠物档案</h3>
                <p>记录宠物的生活点滴、照片、视频等美好回忆</p>
            </div>
            <div class="feature">
                <div class="feature-icon">📚</div>
                <h3>收藏集</h3>
                <p>整理家族照片、重要文档、历史资料等</p>
            </div>
        </div>

        <div class="card">
            <h2>🚀 系统管理</h2>
            
            <div class="controls-section">
                <div class="control-panel">
                    <h3>📊 系统状态</h3>
                    <button class="button" onclick="checkHealth()">检查系统健康状态</button>
                    <button class="button secondary" onclick="getStats()">获取系统统计</button>
                    <button class="button secondary" onclick="getTLogStatus()">透明日志状态</button>
                    <div id="systemResponse" class="response"></div>
                </div>

                <div class="control-panel">
                    <h3>➕ 创建新档案</h3>
                    <div class="form-group">
                        <label>档案类型</label>
                        <select id="tierSelect">
                            <option value="citizen">👤 市民档案</option>
                            <option value="pet">🐕 宠物档案</option>
                            <option value="collection">📚 收藏集</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>姓名/名称</label>
                        <input type="text" id="nameInput" placeholder="请输入姓名或名称">
                    </div>
                    <div class="form-group">
                        <label>地区</label>
                        <input type="text" id="regionInput" placeholder="如：北京、上海">
                    </div>
                    <div class="form-group">
                        <label>时代</label>
                        <input type="text" id="eraInput" placeholder="如：现代、民国">
                    </div>
                    <div class="form-group">
                        <label>标签 (用逗号分隔)</label>
                        <input type="text" id="tagsInput" placeholder="如：工程师,父亲,摄影爱好者">
                    </div>
                    <div class="form-group">
                        <label>访问权限</label>
                        <select id="accessSelect">
                            <option value="public">🌐 公开</option>
                            <option value="link">🔗 仅限链接</option>
                            <option value="private">🔒 私密</option>
                        </select>
                    </div>
                    <button class="button" onclick="createItem()">创建档案</button>
                    <div id="createResponse" class="response"></div>
                </div>
            </div>
        </div>

        <!-- P2P网络状态卡片 -->
        <div class="card">
            <h2>🌐 P2P网络状态</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getP2PStatus()">刷新P2P状态</button>
                <button class="button secondary" onclick="toggleP2PAutoRefresh()">自动刷新 (关)</button>
            </div>
            
            <div id="p2pStatusContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">🌐</div>
                    <h3>P2P网络状态</h3>
                    <p>点击上方按钮获取P2P网络状态</p>
                </div>
            </div>
        </div>

        <!-- 全球网络状态卡片 -->
        <div class="card">
            <h2>🌍 全球网络状态</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getGlobalNetworkStatus()">刷新全球状态</button>
            </div>
            
            <div id="globalNetworkContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">🌍</div>
                    <h3>全球网络状态</h3>
                    <p>点击上方按钮获取全球网络状态</p>
                </div>
            </div>
        </div>

        <!-- 网络拓扑信息卡片 -->
        <div class="card">
            <h2>🌐 网络拓扑信息</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getNetworkTopology()">刷新拓扑信息</button>
            </div>
            
            <div id="topologyContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">🌐</div>
                    <h3>网络拓扑信息</h3>
                    <p>点击上方按钮获取网络拓扑信息</p>
                </div>
            </div>
        </div>

        <!-- 中继节点信息卡片 -->
        <div class="card">
            <h2>🔄 中继节点信息</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getRelayNodesInfo()">刷新中继信息</button>
            </div>
            
            <div id="relayContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">🔄</div>
                    <h3>中继节点信息</h3>
                    <p>点击上方按钮获取中继节点信息</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>📋 档案管理</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getUnifiedItems()">获取档案</button>
                <button class="button secondary" onclick="getItemsByType('citizen')">获取市民档案</button>
                <button class="button secondary" onclick="getItemsByType('pet')">获取宠物档案</button>
                <button class="button secondary" onclick="getItemsByType('collection')">获取收藏集</button>
                <button class="button secondary" onclick="syncUnifiedItems()">同步网络档案</button>
            </div>
            
            <div id="itemsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <h3>暂无档案数据</h3>
                    <p>点击上方按钮获取档案列表</p>
                </div>
            </div>
        </div>

        <!-- 档案修改删除模块 -->
        <div class="card">
            <h2>✏️ 档案修改 & 删除</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">
                🔐 <strong>身份验证说明：</strong>
                <br>• 可以直接修改/删除本节点创建的档案
                <br>• 修改其他节点的档案需要提供创建者的节点ID进行验证
            </p>
            
            <!-- 当前节点信息 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">🆔</span>
                    <div>
                        <strong>当前节点ID：</strong>
                        <span id="currentNodeId" style="font-family: monospace; font-size: 0.9rem; color: #007bff;">加载中...</span>
                    </div>
                </div>
            </div>

                            <!-- 修改档案区域 -->
                <div style="border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                    <h3 id="editArchiveTitle" style="color: #28a745; margin-bottom: 15px;">📝 修改档案</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">档案ID：</label>
                    <input type="text" id="editHeavenId" placeholder="输入要修改的档案ID (例: HT-2025-CIT12345678)" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">节点ID验证 (可选)：</label>
                    <input type="text" id="editVerifyNodeId" placeholder="如果要修改其他节点的档案，请输入创建者的节点ID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
                    <small style="color: #6c757d;">💡 提示：修改本节点创建的档案无需填写此字段</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">档案类型：</label>
                        <select id="editTier" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="citizen">👤 市民档案</option>
                            <option value="pet">🐕 宠物档案</option>
                            <option value="collection">📚 收藏集</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">访问权限：</label>
                        <select id="editAccess" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="public">🌍 公开</option>
                            <option value="private">🔒 私有</option>
                            <option value="restricted">⚠️ 受限</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">姓名/名称：</label>
                    <input type="text" id="editNameInput" placeholder="请输入姓名或名称" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">地区：</label>
                    <input type="text" id="editRegionInput" placeholder="如：北京、上海" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">时代：</label>
                    <input type="text" id="editEraInput" placeholder="如：现代、民国" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">标签 (用逗号分隔)：</label>
                    <input type="text" id="editTagsInput" placeholder="如：工程师,父亲,摄影爱好者" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="button" onclick="loadItemForEdit()" style="background: #17a2b8;">📥 加载档案</button>
                    <button class="button" onclick="updateItem()" style="background: #28a745;">💾 保存修改</button>
                </div>
            </div>

                            <!-- 删除档案区域 -->
                <div style="border: 2px solid #dc3545; border-radius: 10px; padding: 20px;">
                    <h3 id="deleteArchiveTitle" style="color: #dc3545; margin-bottom: 15px;">🗑️ 删除档案</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">档案ID：</label>
                    <input type="text" id="deleteHeavenId" placeholder="输入要删除的档案ID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">节点ID验证 (可选)：</label>
                    <input type="text" id="deleteVerifyNodeId" placeholder="如果要删除其他节点的档案，请输入创建者的节点ID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
                    <small style="color: #6c757d;">💡 提示：删除本节点创建的档案无需填写此字段</small>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="button secondary" onclick="previewDeleteItem()" style="background: #6c757d;">👁️ 预览档案</button>
                    <button class="button" onclick="deleteItem()" style="background: #dc3545;">🗑️ 确认删除</button>
                </div>
            </div>

            <!-- 操作结果显示区域 -->
            <div id="editDeleteResult" style="margin-top: 20px;"></div>
        </div>

        <div class="card">
            <h2>🔗 服务地址</h2>
            <p><strong>后端 API:</strong> <a href="http://localhost:8080" target="_blank">http://localhost:8080</a> <span class="status online" id="apiStatus">在线</span></p>
            <p><strong>MinIO 控制台:</strong> <a href="http://localhost:9001" target="_blank">http://localhost:9001</a> (用户名/密码: minioadmin)</p>
            <p><strong>NATS 监控:</strong> <a href="http://localhost:8222" target="_blank">http://localhost:8222</a></p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                // 检查响应是否为JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    return { 
                        success: false, 
                        error: `服务器返回非JSON响应: ${text.substring(0, 100)}...`,
                        status: response.status 
                    };
                }
                
                const result = await response.json();
                console.log('API Response:', { endpoint, status: response.status, result });
                
                // 如果后端返回的数据包含 success 字段，直接返回
                // 否则包装成标准格式
                if (result.hasOwnProperty('success')) {
                    return { success: response.ok, data: result, status: response.status };
                } else {
                    return { success: response.ok, data: { data: result, success: true }, status: response.status };
                }
            } catch (error) {
                console.error('API Call Error:', { endpoint, error });
                return { success: false, error: error.message, status: 'network_error' };
            }
        }

        async function checkHealth() {
            try {
                const result = await apiCall('/api/v1/health');
                console.log('健康检查响应:', result); // 调试日志
                
                if (result.success && result.data) {
                    document.getElementById('systemResponse').textContent = JSON.stringify(result.data, null, 2);
                    
                    // 更新状态指示器
                    const statusElement = document.getElementById('apiStatus');
                    if (statusElement) {
                        statusElement.textContent = '在线';
                        statusElement.className = 'status online';
                    }
                } else {
                    document.getElementById('systemResponse').textContent = JSON.stringify(result, null, 2);
                    
                    // 更新状态指示器
                    const statusElement = document.getElementById('apiStatus');
                    if (statusElement) {
                        statusElement.textContent = '离线';
                        statusElement.className = 'status offline';
                    }
                }
            } catch (error) {
                console.error('健康检查失败:', error);
                document.getElementById('systemResponse').textContent = `健康检查失败: ${error.message}`;
                
                // 更新状态指示器
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    statusElement.textContent = '错误';
                    statusElement.className = 'status offline';
                }
            }
        }

        async function getStats() {
            const result = await apiCall('/api/v1/stats');
            document.getElementById('systemResponse').textContent = JSON.stringify(result.data, null, 2);
        }

        async function getTLogStatus() {
            const result = await apiCall('/api/v1/tlog/sth');
            document.getElementById('systemResponse').textContent = JSON.stringify(result.data, null, 2);
        }

        async function getAllItems() {
            await loadItems('/api/v1/p2p/items/');
        }

        async function getItemsByType(tier) {
            await loadItems(`/api/v1/p2p/items/?tier=${tier}`, `${tier}档案`);
        }

        // loadItems函数已移动到下方，支持数据源标识

        // displayItems函数已移动到下方，支持数据源标识

        function createItemCard(item) {
            const tierIcons = {
                citizen: '👤',
                pet: '🐕',
                collection: '📚'
            };

            const accessIcons = {
                public: '🌐',
                link: '🔗',
                private: '🔒'
            };

            const accessLabels = {
                public: '公开',
                link: '仅限链接',
                private: '私密'
            };

            const tierLabels = {
                citizen: '市民档案',
                pet: '宠物档案',
                collection: '收藏集'
            };

            const tags = item.meta.tags ? item.meta.tags.map(tag => 
                `<span class="tag">${tag}</span>`
            ).join('') : '';

            const createdDate = new Date(item.created_at).toLocaleString('zh-CN');

            return `
                <div class="item-card ${item.tier}">
                    <div class="access-badge ${item.access}">
                        ${accessIcons[item.access]} ${accessLabels[item.access]}
                    </div>
                    
                    <div class="item-header">
                        <div class="item-icon ${item.tier}">
                            ${tierIcons[item.tier]}
                        </div>
                        <div>
                            <div class="item-title">${item.meta.name || '未命名'}</div>
                            <div class="item-id">${item.heaven_id}</div>
                        </div>
                    </div>
                    
                    <div class="item-meta">
                        <div class="meta-row">
                            <span class="meta-icon">📍</span>
                            <span>${item.meta.region || '未知地区'}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-icon">🕐</span>
                            <span>${item.meta.era || '未知时代'}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-icon">📂</span>
                            <span>${tierLabels[item.tier]}</span>
                        </div>
                    </div>
                    
                    ${tags ? `<div class="item-tags">${tags}</div>` : ''}
                    
                    <div class="item-footer">
                        <span>创建时间: ${createdDate}</span>
                    </div>
                </div>
            `;
        }

        async function createItem() {
            console.log('🚀 开始创建档案...'); // 调试日志
            const tier = document.getElementById('tierSelect').value;
            const name = document.getElementById('nameInput').value;
            const region = document.getElementById('regionInput').value;
            const era = document.getElementById('eraInput').value;
            const tags = document.getElementById('tagsInput').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const access = document.getElementById('accessSelect').value;

            console.log('📝 表单数据:', { tier, name, region, era, tags, access }); // 调试日志

            if (!name) {
                alert('请输入姓名或名称');
                return;
            }

            const data = {
                tier,
                owner_pubkey: 'ed25519:demo_key',
                meta: {
                    name,
                    region: region || '未知',
                    era: era || '现代',
                    tags
                },
                access
            };

            const result = await apiCall('/api/v1/p2p/items/', 'POST', data);
            console.log('📤 创建档案API响应:', result); // 调试日志
            document.getElementById('createResponse').textContent = JSON.stringify(result, null, 2);
            
            if (result.success) {
                // 清空表单
                document.getElementById('nameInput').value = '';
                document.getElementById('regionInput').value = '';
                document.getElementById('eraInput').value = '';
                document.getElementById('tagsInput').value = '';
                
                // 刷新档案列表
                getUnifiedItems();
            }
        }

        // P2P状态相关功能
        let p2pAutoRefresh = false;
        let p2pRefreshInterval = null;

        async function getP2PStatus() {
            const container = document.getElementById('p2pStatusContainer');
            container.innerHTML = '<div class="loading">🔄 正在获取P2P网络状态...</div>';
            
            try {
                const response = await apiCall('/api/v1/p2p/status');
                if (response.success) {
                    // 支持两种数据结构
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayP2PStatus(data);
                    
                    // 同时更新其他网络状态信息
                    console.log('🔄 开始更新其他网络状态...');
                    await Promise.all([
                        getGlobalNetworkStatus(),
                        getNetworkTopology(),
                        getRelayNodesInfo()
                    ]);
                    console.log('✅ 所有网络状态更新完成');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">❌</div>
                            <h3>P2P状态获取失败</h3>
                            <p>HTTP状态: ${response.status}</p>
                            <p>错误信息: ${response.error || 'API调用失败'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <h3>P2P状态获取失败</h3>
                        <p>错误信息: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 新增：获取全球网络状态
        async function getGlobalNetworkStatus() {
            try {
                const response = await apiCall('/api/v1/global/status');
                if (response.success) {
                    // 支持两种数据结构
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayGlobalNetworkStatus(data);
                } else {
                    console.error('获取全球网络状态失败:', response.error);
                }
            } catch (error) {
                console.error('获取全球网络状态失败:', error);
            }
        }

        // 新增：获取网络拓扑信息
        async function getNetworkTopology() {
            try {
                const response = await apiCall('/api/v1/global/topology');
                if (response.success) {
                    // 支持两种数据结构
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayNetworkTopology(data);
                } else {
                    console.error('获取网络拓扑失败:', response.error);
                }
            } catch (error) {
                console.error('获取网络拓扑失败:', error);
            }
        }

        // 新增：获取中继节点信息
        async function getRelayNodesInfo() {
            try {
                const response = await apiCall('/api/v1/global/relay');
                if (response.success) {
                    // 支持两种数据结构
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayRelayNodesInfo(data);
                } else {
                    console.error('获取中继节点信息失败:', response.error);
                }
            } catch (error) {
                console.error('获取中继节点信息失败:', error);
            }
        }

        // 新增：显示全球网络状态
        function displayGlobalNetworkStatus(data) {
            const container = document.getElementById('globalNetworkContainer');
            if (!container) {
                console.warn('globalNetworkContainer元素不存在');
                return;
            }
            
            try {
                console.log('全球网络状态数据:', data);
                
                container.innerHTML = `
                    <div class="global-network-status">
                        <h3>🌍 全球网络状态</h3>
                        <div class="status-item">
                            <span class="status-label">网络状态</span>
                            <span class="status-value">${data.network_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">发现状态</span>
                            <span class="status-value">${data.discovery_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中继功能</span>
                            <span class="status-value">${data.relay_enabled ? '✅ 启用' : '❌ 禁用'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">地理位置感知</span>
                            <span class="status-value">${data.geo_aware ? '✅ 启用' : '❌ 禁用'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">总节点数</span>
                            <span class="status-value">${data.total_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">已连接节点</span>
                            <span class="status-value">${data.connected_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">监听地址</span>
                            <span class="status-value">${(data.listen_addrs || []).length} 个</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">外部地址</span>
                            <span class="status-value">${(data.external_addrs || []).length} 个</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">最大连接数</span>
                            <span class="status-value">${data.max_peers || 'unlimited'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">同步间隔</span>
                            <span class="status-value">${data.sync_interval || '60s'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">数据分片大小</span>
                            <span class="status-value">${(data.chunk_size || 1048576) / 1024 / 1024}MB</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">复制因子</span>
                            <span class="status-value">${data.replication_factor || 3}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('显示全球网络状态失败:', error);
                container.innerHTML = '<div class="error">显示全球网络状态失败</div>';
            }
        }

        // 新增：显示网络拓扑信息
        function displayNetworkTopology(data) {
            const container = document.getElementById('topologyContainer');
            if (!container) {
                console.warn('topologyContainer元素不存在');
                return;
            }
            
            try {
                console.log('网络拓扑数据:', data);
                
                // 计算网络健康度颜色
                const healthColor = data.network_health === 'excellent' ? '#28a745' : 
                                   data.network_health === 'good' ? '#17a2b8' :
                                   data.network_health === 'fair' ? '#ffc107' : 
                                   data.network_health === 'isolated' ? '#6c757d' : '#dc3545';
                
                // 计算网络密度进度条
                const densityPercent = parseFloat(data.network_density) || 0;
                
                container.innerHTML = `
                    <div class="network-topology">
                        <h3>🌐 网络拓扑信息</h3>
                        <div class="status-item">
                            <span class="status-label">网络健康度</span>
                            <span class="status-value" style="color: ${healthColor}; font-weight: bold;">
                                ${data.network_health || 'unknown'}
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">拓扑类型</span>
                            <span class="status-value">${data.topology_type || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">总节点数</span>
                            <span class="status-value">${data.total_nodes || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">已连接节点</span>
                            <span class="status-value">${data.connected_nodes || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">网络密度</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${densityPercent}%; background: ${healthColor};"></div>
                                <span class="progress-text">${data.network_density || '0%'}</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">路由效率</span>
                            <span class="status-value">${data.routing_efficiency || '0%'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">最后更新</span>
                            <span class="status-value">${data.last_updated || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">拓扑特性</span>
                            <span class="status-value">${(data.topology_features || []).join(', ') || '无'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('显示网络拓扑信息失败:', error);
                container.innerHTML = '<div class="error">显示网络拓扑信息失败</div>';
            }
        }

        // 新增：显示中继节点信息
        function displayRelayNodesInfo(data) {
            const container = document.getElementById('relayContainer');
            if (!container) {
                console.warn('relayContainer元素不存在');
                return;
            }
            
            try {
                container.innerHTML = `
                    <div class="relay-nodes-info">
                        <h3>🔄 中继节点信息</h3>
                        <div class="status-item">
                            <span class="status-label">中继节点数</span>
                            <span class="status-value">${data.relay_count || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中继状态</span>
                            <span class="status-value">${data.relay_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">最后更新</span>
                            <span class="status-value">${data.last_updated || 'unknown'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('显示中继节点信息失败:', error);
                container.innerHTML = '<div class="error">显示中继节点信息失败</div>';
            }
        }

        function displayP2PStatus(data) {
            const container = document.getElementById('p2pStatusContainer');
            
            // 调试信息
            console.log('P2P Status Data:', data);
            
            // 兼容新旧两种格式
            const nodeId = data.node?.id || data.node_id || '未知';
            const status = data.status || 'unknown';
            const port = data.node?.port || 8080;
            const protocolVersion = data.node?.protocol_version || '2.0.0-global';
            
            // 连接信息 - 兼容新旧格式
            const connectedPeers = data.connections?.bootstrap_nodes?.connected || 
                                  data.connections?.peers?.connected || 
                                  data.connected_peers || 0;
            const totalPeers = data.connections?.bootstrap_nodes?.total || 
                              data.connections?.peers?.total || 
                              data.total_peers || 0;
            const discoveredPeers = data.connections?.peers?.discovered || 0;
            const iheavenNodes = data.connections?.peers?.iheaven_nodes || 0;
            
            const successRate = totalPeers > 0 ? `${Math.round(connectedPeers / totalPeers * 100)}%` : '0%';
            const progressPercent = totalPeers > 0 ? (connectedPeers / totalPeers * 100) : 0;
            
            const statusClass = status === 'healthy' || status === 'active' ? 'healthy' : 
                               status === 'starting' ? 'starting' : 'offline';
            
            container.innerHTML = `
                <div class="p2p-status">
                    <!-- 节点信息 -->
                    <div class="p2p-section">
                        <h3>🆔 节点信息</h3>
                        <div class="status-item">
                            <span class="status-label">状态</span>
                            <span class="status-badge status-${statusClass}">${status}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">节点ID</span>
                            <div class="node-id" style="word-break: break-all; font-family: monospace; font-size: 0.8rem;">${nodeId}</div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">监听端口</span>
                            <span class="status-value">${port}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">协议版本</span>
                            <span class="status-value">${protocolVersion}</span>
                        </div>
                    </div>

                    <!-- 网络连接 -->
                    <div class="p2p-section">
                        <h3>🔗 网络连接</h3>
                        <div class="status-item">
                            <span class="status-label">连接成功率</span>
                            <span class="status-value">${successRate}</span>
                        </div>
                        <div class="progress-bar" style="background: #e9ecef; height: 8px; border-radius: 4px; margin: 8px 0;">
                            <div class="progress-fill" style="background: #007bff; height: 100%; border-radius: 4px; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">已连接/总数</span>
                            <span class="status-value">${connectedPeers}/${totalPeers}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">发现的节点</span>
                            <span class="status-value">${discoveredPeers}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">iHeaven节点</span>
                            <span class="status-value">${iheavenNodes}</span>
                        </div>
                    </div>

                    <!-- 网络协议 -->
                    <div class="p2p-section">
                        <h3>📡 网络协议</h3>
                        <div class="status-item">
                            <span class="status-label">DHT状态</span>
                            <span class="status-value">${data.dht_status || 'active'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">发现状态</span>
                            <span class="status-value">${data.discovery_status || 'running'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">同步状态</span>
                            <span class="status-value">${data.sync_status || 'active'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- 新增：全球网络状态按钮 -->
                <div style="text-align: center; margin-top: 20px;">
                                    <button class="button" onclick="refreshAllNetworkStatus()">
                    🔄 刷新所有网络状态
                </button>
                <button class="button secondary" onclick="startRealTimeMonitoring()">
                    🕐 启动实时监控
                </button>
                <button class="button secondary" onclick="stopRealTimeMonitoring()">
                    ⏹️ 停止实时监控
                </button>
                <div id="refreshInfo" class="refresh-info">
                    <span>🕐 最后刷新: 未刷新</span>
                    <span>⏱️ 自动刷新: 关闭</span>
                </div>
                </div>
            `;
        }

        // 新增：显示全球网络状态
        function displayGlobalNetworkStatus(data) {
            const container = document.getElementById('globalNetworkContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="p2p-status">
                    <!-- 全球网络概览 -->
                    <div class="p2p-section">
                        <h3>🌍 全球网络概览</h3>
                        <div class="status-item">
                            <span class="status-label">网络状态</span>
                            <span class="status-badge status-${data.network_status === 'active' ? 'healthy' : 'offline'}">${data.network_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">发现状态</span>
                            <span class="status-badge status-${data.discovery_status === 'running' ? 'healthy' : 'offline'}">${data.discovery_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中继功能</span>
                            <span class="status-value">${data.relay_enabled ? '✅ 启用' : '❌ 禁用'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">地理位置感知</span>
                            <span class="status-value">${data.geo_aware ? '✅ 启用' : '❌ 禁用'}</span>
                        </div>
                    </div>

                    <!-- 节点统计 -->
                    <div class="p2p-section">
                        <h3>📊 节点统计</h3>
                        <div class="status-item">
                            <span class="status-label">总节点数</span>
                            <span class="status-value">${data.total_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">已连接节点</span>
                            <span class="status-value">${data.connected_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">监听地址</span>
                            <span class="status-value">${(data.listen_addrs || []).length} 个</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">外部地址</span>
                            <span class="status-value">${(data.external_addrs || []).length} 个</span>
                        </div>
                    </div>

                    <!-- 网络配置 -->
                    <div class="p2p-section">
                        <h3>⚙️ 网络配置</h3>
                        <div class="status-item">
                            <span class="status-label">最大连接数</span>
                            <span class="status-value">${data.max_peers || 'unlimited'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">同步间隔</span>
                            <span class="status-value">${data.sync_interval || '60s'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">数据分片大小</span>
                            <span class="status-value">${data.chunk_size ? Math.round(data.chunk_size / 1024 / 1024) + 'MB' : '1MB'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">复制因子</span>
                            <span class="status-value">${data.replication_factor || 3}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 网络拓扑信息显示函数已移动到下方，支持正确的数据结构

        // 新增：显示中继节点信息
        function displayRelayNodesInfo(data) {
            const container = document.getElementById('relayContainer');
            if (!container) {
                console.warn('relayContainer元素不存在');
                return;
            }
            
            try {
                console.log('中继节点数据:', data);
                
                container.innerHTML = `
                    <div class="p2p-section">
                        <h3>🔄 中继节点</h3>
                        <div class="status-item">
                            <span class="status-label">中继状态</span>
                            <span class="status-value">${data.relay_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中继节点数</span>
                            <span class="status-value">${data.total_relay_nodes || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">客户端数</span>
                            <span class="status-value">${data.total_clients || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">总容量</span>
                            <span class="status-value">${data.total_capacity || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">当前负载</span>
                            <span class="status-value">${data.total_load || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">容量使用率</span>
                            <span class="status-value">${data.capacity_usage || '0%'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中继效率</span>
                            <span class="status-value">${data.relay_efficiency || '0%'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">平均分数</span>
                            <span class="status-value">${data.average_score ? data.average_score.toFixed(2) : 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">最后更新</span>
                            <span class="status-value">${data.last_updated || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中继特性</span>
                            <span class="status-value">${(data.relay_features || []).join(', ') || '无'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">成功率</span>
                            <span class="status-value">${data.relay_stats?.success_rate || 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">平均响应时间</span>
                            <span class="status-value">${data.relay_stats?.avg_response_time || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('显示中继节点信息失败:', error);
                container.innerHTML = '<div class="error">显示中继节点信息失败</div>';
            }
        }

        // 新增：刷新所有网络状态
        async function refreshAllNetworkStatus() {
            console.log('🔄 开始刷新所有网络状态...');
            
            try {
                // 并行获取所有状态
                await Promise.all([
                    getP2PStatus(),
                    getGlobalNetworkStatus(),
                    getNetworkTopology(),
                    getRelayNodesInfo()
                ]);
                
                console.log('✅ 所有网络状态刷新完成');
            } catch (error) {
                console.error('刷新网络状态失败:', error);
            }
        }

        function toggleP2PAutoRefresh() {
            const button = event.target;
            
            if (p2pAutoRefresh) {
                // 停止自动刷新
                p2pAutoRefresh = false;
                clearInterval(p2pRefreshInterval);
                button.textContent = '自动刷新 (关)';
                button.classList.remove('button');
                button.classList.add('button', 'secondary');
            } else {
                // 开启自动刷新
                p2pAutoRefresh = true;
                p2pRefreshInterval = setInterval(getP2PStatus, 10000); // 每10秒刷新
                button.textContent = '自动刷新 (开)';
                button.classList.remove('secondary');
                
                // 立即刷新一次
                getP2PStatus();
            }
        }

        // 统一档案管理函数
        async function getUnifiedItems() {
            console.log('🔍 开始获取统一档案...');
            await loadItems('/api/v1/p2p/items/', '统一档案');
        }

        async function syncUnifiedItems() {
            try {
                const response = await apiCall('/api/v1/p2p/items/sync', 'POST');
                if (response.success) {
                    alert('档案网络同步已启动');
                    // 刷新档案列表
                    getUnifiedItems();
                } else {
                    alert('同步失败: ' + (response.error || '未知错误'));
                }
            } catch (error) {
                alert('同步失败: ' + error.message);
            }
        }

        // createUnifiedItem函数已删除，使用createItem函数替代

        // 修改原有的loadItems函数，支持数据源标识
        async function loadItems(endpoint, sourceLabel = '档案') {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '<div class="loading">🔄 正在加载' + sourceLabel + '...</div>';
            
            try {
                const response = await apiCall(endpoint);
                console.log('loadItems response:', response); // 调试日志
                
                if (response.success && response.data) {
                    // 检查response.data的结构
                    console.log('API响应数据结构:', response.data); // 调试日志
                    const actualData = response.data.data || response.data;
                    console.log('实际数据:', actualData); // 调试日志
                    if (Array.isArray(actualData) && actualData.length > 0) {
                        displayItems(actualData, sourceLabel);
                    } else if (actualData.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">📋</div>
                                <h3>暂无${sourceLabel}数据</h3>
                                <p>数据源: ${response.source || '未知'}</p>
                                <p>API响应正常，但没有数据</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">❓</div>
                                <h3>数据格式异常</h3>
                                <p>数据源: ${response.source || '未知'}</p>
                                <p>响应数据不是数组格式</p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">❌</div>
                            <h3>API响应失败</h3>
                            <p>错误: ${response.error || 'API返回success=false'}</p>
                            <p>状态: ${response.status || '未知'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('loadItems error:', error); // 调试日志
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <h3>${sourceLabel}加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请检查浏览器控制台获取详细信息</p>
                    </div>
                `;
            }
        }

        // 修改displayItems函数，显示数据源信息
        function displayItems(items, sourceLabel = '档案') {
            const container = document.getElementById('itemsContainer');
            
            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>暂无${sourceLabel}数据</h3>
                    </div>
                `;
                return;
            }

            const tierIcons = {
                'citizen': '👤',
                'pet': '🐕',
                'collection': '📚'
            };

            let itemsHTML = `
                <div class="items-header" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <h3>📊 ${sourceLabel}数据 (共 ${items.length} 个)</h3>
                    <p style="font-size: 0.9rem; color: #6c757d;">
                        数据源: ${items[0]?.source || '未知'} | 
                        最后更新: ${new Date().toLocaleString()}
                    </p>
                </div>
                <div class="items-grid">
            `;
            
            items.forEach(item => {
                const meta = item.meta || {};
                const tags = meta.tags || [];
                const tagsHTML = tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                
                itemsHTML += `
                    <div class="item-card ${item.tier}">
                        <div class="item-decoration"></div>
                        
                        <div class="item-header">
                            <div class="item-icon ${item.tier}">
                                ${tierIcons[item.tier]}
                            </div>
                            <div>
                                <div class="item-title">${meta.name || '未命名'}</div>
                                <div class="item-id">${item.heaven_id}</div>
                            </div>
                        </div>

                        <div class="item-meta">
                            <div class="meta-row">
                                <span class="meta-icon">🌍</span>
                                地区: ${meta.region || '未知'}
                            </div>
                            <div class="meta-row">
                                <span class="meta-icon">⏰</span>
                                时代: ${meta.era || '未知'}
                            </div>
                            <div class="meta-row">
                                <span class="meta-icon">🔑</span>
                                访问: <span class="access-badge ${item.access}">${item.access}</span>
                            </div>
                            ${item.source ? `
                            <div class="meta-row">
                                <span class="meta-icon">💾</span>
                                来源: <span style="font-family: monospace; font-size: 0.8rem;">${item.source}</span>
                            </div>
                            ` : ''}

                        </div>

                        ${tagsHTML ? `<div class="item-tags">${tagsHTML}</div>` : ''}

                        <div class="item-footer">
                            创建时间: ${new Date(item.created_at).toLocaleString()}
                            ${item.version ? ` | 版本: v${item.version}` : ''}
                        </div>
                        
                        <div class="item-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button class="button" onclick="fillEditForm('${item.heaven_id}')" 
                                    style="background: #28a745; font-size: 0.85rem; padding: 8px 12px;">
                                ✏️ 编辑
                            </button>
                            <button class="button" onclick="fillDeleteForm('${item.heaven_id}')" 
                                    style="background: #dc3545; font-size: 0.85rem; padding: 8px 12px;">
                                🗑️ 删除
                            </button>

                        </div>
                    </div>
                `;
            });
            
            itemsHTML += '</div>';
            container.innerHTML = itemsHTML;
        }

        // 获取当前节点ID并显示
        async function loadCurrentNodeId() {
            try {
                const response = await apiCall('/api/v1/p2p/status');
                console.log('节点ID响应:', response); // 调试日志
                
                // 检查响应结构
                if (response.success && response.data) {
                    console.log('响应数据:', response.data);
                    
                    // 检查是否有node字段 - 支持两种数据结构
                    let nodeData = response.data;
                    if (response.data.data && response.data.data.node) {
                        // 如果数据嵌套在 data.data 中
                        nodeData = response.data.data;
                    }
                    
                    if (nodeData.node && nodeData.node.id) {
                        const nodeId = nodeData.node.id;
                        console.log('获取到节点ID:', nodeId);
                        document.getElementById('currentNodeId').textContent = nodeId;
                        return nodeId;
                    } else {
                        console.error('响应中缺少node字段或node.id:', nodeData);
                        document.getElementById('currentNodeId').textContent = '节点信息缺失';
                        return null;
                    }
                } else {
                    console.error('API响应失败:', response);
                    document.getElementById('currentNodeId').textContent = 'API响应失败';
                    return null;
                }
            } catch (error) {
                console.error('获取节点ID失败:', error);
                document.getElementById('currentNodeId').textContent = '获取失败';
                return null;
            }
        }

        // 加载档案用于编辑
        async function loadItemForEdit() {
            const heavenId = document.getElementById('editHeavenId').value.trim();
            
            if (!heavenId) {
                showEditDeleteResult('error', '请输入档案ID');
                return;
            }

            try {
                const response = await apiCall(`/api/v1/p2p/items/${heavenId}`);
                
                if (response.success && response.data) {
                    const item = response.data;
                    
                    // 填充表单
                    document.getElementById('editTier').value = item.tier;
                    document.getElementById('editAccess').value = item.access;
                    
                    // 填充meta字段的各个部分
                    document.getElementById('editNameInput').value = item.meta.name || '';
                    document.getElementById('editRegionInput').value = item.meta.region || '';
                    document.getElementById('editEraInput').value = item.meta.era || '';
                    
                    // 处理标签数组
                    if (item.meta.tags && Array.isArray(item.meta.tags)) {
                        document.getElementById('editTagsInput').value = item.meta.tags.join(', ');
                    } else {
                        document.getElementById('editTagsInput').value = '';
                    }
                    
                    showEditDeleteResult('success', `✅ 档案加载成功！<br><strong>档案名:</strong> ${item.meta.name || '未命名'}<br><strong>创建时间:</strong> ${new Date(item.created_at).toLocaleString()}`);
                } else {
                    showEditDeleteResult('error', '档案不存在或加载失败');
                }
            } catch (error) {
                console.error('加载档案失败:', error);
                showEditDeleteResult('error', '加载档案失败: ' + error.message);
            }
        }

        // 更新档案
        async function updateItem() {
            const heavenId = document.getElementById('editHeavenId').value.trim();
            const verifyNodeId = document.getElementById('editVerifyNodeId').value.trim();
            const tier = document.getElementById('editTier').value;
            const access = document.getElementById('editAccess').value;
            
            // 从各个输入字段获取meta数据
            const name = document.getElementById('editNameInput').value.trim();
            const region = document.getElementById('editRegionInput').value.trim();
            const era = document.getElementById('editEraInput').value.trim();
            const tagsText = document.getElementById('editTagsInput').value.trim();

            if (!heavenId) {
                showEditDeleteResult('error', '请输入档案ID');
                return;
            }

            if (!name) {
                showEditDeleteResult('error', '请输入姓名/名称');
                return;
            }

            // 构建meta对象
            const meta = {
                name: name,
                region: region || '',
                era: era || ''
            };

            // 处理标签
            if (tagsText) {
                meta.tags = tagsText.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            } else {
                meta.tags = [];
            }

            console.log('Built meta object:', meta);

            try {
                const headers = {};
                if (verifyNodeId) {
                    headers['X-Node-ID'] = verifyNodeId;
                }

                const response = await fetch(`${API_BASE}/api/v1/p2p/items/${heavenId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    body: JSON.stringify({
                        tier: tier,
                        meta: meta,
                        access: access
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showEditDeleteResult('success', `✅ ${result.message}<br><strong>档案ID:</strong> ${heavenId}<br><strong>版本:</strong> v${result.data.version}`);
                    // 清空验证节点ID字段
                    document.getElementById('editVerifyNodeId').value = '';
                    // 刷新档案列表
                    getUnifiedItems();
                } else {
                    showEditDeleteResult('error', `❌ ${result.error}`);
                }
            } catch (error) {
                console.error('更新档案失败:', error);
                showEditDeleteResult('error', '更新档案失败: ' + error.message);
            }
        }

        // 预览要删除的档案
        async function previewDeleteItem() {
            const heavenId = document.getElementById('deleteHeavenId').value.trim();
            
            if (!heavenId) {
                showEditDeleteResult('error', '请输入要预览的档案ID');
                return;
            }

            try {
                const response = await apiCall(`/api/v1/p2p/items/${heavenId}`);
                
                console.log('Preview response:', response);
                
                if (response.success && response.data) {
                    const item = response.data;
                    console.log('Preview item:', item);
                    console.log('Item meta:', item.meta);
                    
                    // 安全地访问meta字段
                    const meta = item.meta || {};
                    const name = meta.name || '未命名';
                    const tier = item.tier || '未知';
                    const nodeId = item.node_id || '未知';
                    const createdAt = item.created_at || new Date();
                    const version = item.version || 0;
                    
                    showEditDeleteResult('info', `
                        📋 <strong>档案预览:</strong><br>
                        <strong>档案ID:</strong> ${item.heaven_id || heavenId}<br>
                        <strong>名称:</strong> ${name}<br>
                        <strong>类型:</strong> ${tier}<br>

                        <strong>创建时间:</strong> ${new Date(createdAt).toLocaleString()}<br>
                        <strong>版本:</strong> v${version}
                    `);
                } else {
                    showEditDeleteResult('error', `档案不存在或预览失败: ${response.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('预览档案失败:', error);
                showEditDeleteResult('error', '预览档案失败: ' + error.message);
            }
        }

        // 删除档案
        async function deleteItem() {
            const heavenId = document.getElementById('deleteHeavenId').value.trim();
            const verifyNodeId = document.getElementById('deleteVerifyNodeId').value.trim();

            if (!heavenId) {
                showEditDeleteResult('error', '请输入档案ID');
                return;
            }

            // 确认删除
            if (!confirm(`⚠️ 确认删除档案 ${heavenId}？\n此操作不可撤销！`)) {
                return;
            }

            try {
                const url = new URL(`${API_BASE}/api/v1/p2p/items/${heavenId}`);
                if (verifyNodeId) {
                    url.searchParams.set('node_id', verifyNodeId);
                }

                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const deletedItem = result.deleted_item || result.data || {};
                    const deletedId = deletedItem.heaven_id || heavenId;
                    const deletedAt = deletedItem.deleted_at || new Date();
                    
                    showEditDeleteResult('success', `✅ ${result.message || '档案删除成功'}<br><strong>删除的档案ID:</strong> ${deletedId}<br><strong>删除时间:</strong> ${new Date(deletedAt).toLocaleString()}`);
                    // 清空输入框
                    document.getElementById('deleteHeavenId').value = '';
                    document.getElementById('deleteVerifyNodeId').value = '';
                    // 刷新档案列表
                    getUnifiedItems();
                } else {
                    showEditDeleteResult('error', `❌ ${result.error || '删除失败'}`);
                }
            } catch (error) {
                console.error('删除档案失败:', error);
                showEditDeleteResult('error', '删除档案失败: ' + error.message);
            }
        }

        // 从档案列表填充编辑表单
        function fillEditForm(heavenId) {
            document.getElementById('editHeavenId').value = heavenId;
            
            // 使用更精确的滚动方法
            const editTitle = document.getElementById('editArchiveTitle');
            if (editTitle) {
                const titleRect = editTitle.getBoundingClientRect();
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const targetScrollTop = currentScrollTop + titleRect.top - 20; // 20px的顶部边距
                
                window.scrollTo({
                    top: targetScrollTop,
                    behavior: 'smooth'
                });
            }
            
            // 自动加载档案
            setTimeout(() => loadItemForEdit(), 500);
        }

        // 从档案列表填充删除表单
        function fillDeleteForm(heavenId) {
            document.getElementById('deleteHeavenId').value = heavenId;
            
            // 使用更精确的滚动方法
            const deleteTitle = document.getElementById('deleteArchiveTitle');
            if (deleteTitle) {
                const titleRect = deleteTitle.getBoundingClientRect();
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const targetScrollTop = currentScrollTop + titleRect.top - 20; // 20px的顶部边距
                
                window.scrollTo({
                    top: targetScrollTop,
                    behavior: 'smooth'
                });
            }
            
            // 自动预览档案
            setTimeout(() => previewDeleteItem(), 500);
        }

        // 显示编辑删除操作结果
        function showEditDeleteResult(type, message) {
            const resultDiv = document.getElementById('editDeleteResult');
            
            let bgColor, borderColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = '#d4edda';
                    borderColor = '#c3e6cb';
                    textColor = '#155724';
                    icon = '✅';
                    break;
                case 'error':
                    bgColor = '#f8d7da';
                    borderColor = '#f5c6cb';
                    textColor = '#721c24';
                    icon = '❌';
                    break;
                case 'info':
                    bgColor = '#d1ecf1';
                    borderColor = '#bee5eb';
                    textColor = '#0c5460';
                    icon = 'ℹ️';
                    break;
                default:
                    bgColor = '#f8f9fa';
                    borderColor = '#dee2e6';
                    textColor = '#495057';
                    icon = '📋';
            }

            resultDiv.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; color: ${textColor}; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.2rem;">${icon}</span>
                        <div style="flex: 1; line-height: 1.5;">${message}</div>
                    </div>
                </div>
            `;

            // 注释掉自动滚动，避免干扰用户的操作流程
            // resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 页面加载时检查系统状态并获取档案列表
        window.onload = function() {
            console.log('🚀 页面开始加载...');
            
            // 使用Promise.all来并行加载，避免阻塞
            Promise.allSettled([
                checkHealth().catch(error => console.warn('健康检查失败:', error)),
                getUnifiedItems().catch(error => console.warn('档案加载失败:', error)),
                loadCurrentNodeId().catch(error => console.warn('节点ID加载失败:', error))
            ]).then(() => {
                console.log('✅ 主要功能加载完成');
                
                // 立即加载网络状态，不再延迟
                console.log('🔄 立即开始加载网络状态...');
                try {
                    refreshAllNetworkStatus();
                } catch (error) {
                    console.warn('网络状态加载失败:', error);
                }
            }).catch(error => {
                console.error('页面加载失败:', error);
            });
        };
    </script>
</body>
</html>


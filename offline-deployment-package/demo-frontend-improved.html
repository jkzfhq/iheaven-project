<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iHeaven æ•°å­—æ°¸ç”Ÿç³»ç»Ÿ - æ”¹è¿›ç‰ˆæ¼”ç¤ºé¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .feature {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .feature:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .controls-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 5px;
        }
        
        .button:hover {
            background: #5a6fd8;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.secondary:hover {
            background: #5a6268;
        }
        
        .response {
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .empty-state p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        /* å¡ç‰‡ç½‘æ ¼å¸ƒå±€ */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, rgba(102,126,234,0.1), transparent);
            border-radius: 0 0 0 50px;
        }

        .item-card.citizen {
            border-left-color: #28a745;
        }

        .item-card.pet {
            border-left-color: #fd7e14;
        }

        .item-card.collection {
            border-left-color: #6f42c1;
        }

        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-icon {
            font-size: 2rem;
            margin-right: 12px;
            padding: 8px;
            background: rgba(102,126,234,0.1);
            border-radius: 50%;
        }

        .item-icon.citizen {
            background: rgba(40,167,69,0.1);
        }

        .item-icon.pet {
            background: rgba(253,126,20,0.1);
        }

        .item-icon.collection {
            background: rgba(111,66,193,0.1);
        }

        .item-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .item-id {
            font-size: 0.75rem;
            color: #6c757d;
            font-family: 'Courier New', monospace;
            margin-top: 2px;
        }

        .item-meta {
            margin-bottom: 15px;
        }

        .meta-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .meta-icon {
            width: 16px;
            margin-right: 8px;
            color: #6c757d;
        }

        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .access-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .access-badge.public {
            background: #d4edda;
            color: #155724;
        }

        .access-badge.link {
            background: #fff3cd;
            color: #856404;
        }

        .access-badge.private {
            background: #f8d7da;
            color: #721c24;
        }

        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* P2PçŠ¶æ€æ ·å¼ */
        .p2p-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .p2p-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }

        .p2p-section h3 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #6c757d;
            font-weight: 500;
        }

        .status-value {
            font-weight: 600;
            color: #495057;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-starting {
            background: #fff3cd;
            color: #856404;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .node-id {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        @media (max-width: 768px) {
            .controls-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }
        }

        /* æ–°å¢ï¼šç½‘ç»œçŠ¶æ€å¡ç‰‡æ ·å¼ */
        .network-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .network-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #007bff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .network-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .network-card h3 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .network-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* åˆ·æ–°ä¿¡æ¯æ ·å¼ */
        .refresh-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .refresh-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .network-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #6c757d;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .metric-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .metric-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .metric-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .metric-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .metric-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #007bff, #0056b3);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.success {
            background: linear-gradient(90deg, #28a745, #1e7e34);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #ffc107, #e0a800);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ iHeaven æ•°å­—æ°¸ç”Ÿç³»ç»Ÿ</h1>
            <p>æ°¸è¿œä¿å­˜çè´µçš„è®°å¿†ï¼Œè®©çˆ±æ°¸ç»­ä¼ æ‰¿</p>
        </div>

        <div class="card">
            <h2>ğŸ¯ ç³»ç»Ÿä»‹ç»</h2>
            <p>iHeaven æ˜¯ä¸€ä¸ªæ•°å­—æ°¸ç”Ÿç³»ç»Ÿï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·æ°¸ä¹…ä¿å­˜é‡è¦çš„è®°å¿†å’Œæ–‡æ¡£ã€‚é€šè¿‡å…ˆè¿›çš„é€æ˜æ—¥å¿—æŠ€æœ¯å’Œè§è¯äººæœºåˆ¶ï¼Œç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨å¯ä¿¡ï¼Œæ°¸ä¸ä¸¢å¤±ã€‚</p>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">ğŸ‘¤</div>
                <h3>å¸‚æ°‘æ¡£æ¡ˆ</h3>
                <p>ä¿å­˜äººçš„ç”Ÿå¹³è®°å½•ã€ç…§ç‰‡ã€æ–‡æ¡£ç­‰é‡è¦ä¿¡æ¯</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ•</div>
                <h3>å® ç‰©æ¡£æ¡ˆ</h3>
                <p>è®°å½•å® ç‰©çš„ç”Ÿæ´»ç‚¹æ»´ã€ç…§ç‰‡ã€è§†é¢‘ç­‰ç¾å¥½å›å¿†</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ“š</div>
                <h3>æ”¶è—é›†</h3>
                <p>æ•´ç†å®¶æ—ç…§ç‰‡ã€é‡è¦æ–‡æ¡£ã€å†å²èµ„æ–™ç­‰</p>
            </div>
        </div>

        <div class="card">
            <h2>ğŸš€ ç³»ç»Ÿç®¡ç†</h2>
            
            <div class="controls-section">
                <div class="control-panel">
                    <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
                    <button class="button" onclick="checkHealth()">æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€</button>
                    <button class="button secondary" onclick="getStats()">è·å–ç³»ç»Ÿç»Ÿè®¡</button>
                    <button class="button secondary" onclick="getTLogStatus()">é€æ˜æ—¥å¿—çŠ¶æ€</button>
                    <div id="systemResponse" class="response"></div>
                </div>

                <div class="control-panel">
                    <h3>â• åˆ›å»ºæ–°æ¡£æ¡ˆ</h3>
                    <div class="form-group">
                        <label>æ¡£æ¡ˆç±»å‹</label>
                        <select id="tierSelect">
                            <option value="citizen">ğŸ‘¤ å¸‚æ°‘æ¡£æ¡ˆ</option>
                            <option value="pet">ğŸ• å® ç‰©æ¡£æ¡ˆ</option>
                            <option value="collection">ğŸ“š æ”¶è—é›†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å§“å/åç§°</label>
                        <input type="text" id="nameInput" placeholder="è¯·è¾“å…¥å§“åæˆ–åç§°">
                    </div>
                    <div class="form-group">
                        <label>åœ°åŒº</label>
                        <input type="text" id="regionInput" placeholder="å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·">
                    </div>
                    <div class="form-group">
                        <label>æ—¶ä»£</label>
                        <input type="text" id="eraInput" placeholder="å¦‚ï¼šç°ä»£ã€æ°‘å›½">
                    </div>
                    <div class="form-group">
                        <label>æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
                        <input type="text" id="tagsInput" placeholder="å¦‚ï¼šå·¥ç¨‹å¸ˆ,çˆ¶äº²,æ‘„å½±çˆ±å¥½è€…">
                    </div>
                    <div class="form-group">
                        <label>è®¿é—®æƒé™</label>
                        <select id="accessSelect">
                            <option value="public">ğŸŒ å…¬å¼€</option>
                            <option value="link">ğŸ”— ä»…é™é“¾æ¥</option>
                            <option value="private">ğŸ”’ ç§å¯†</option>
                        </select>
                    </div>
                    <button class="button" onclick="createItem()">åˆ›å»ºæ¡£æ¡ˆ</button>
                    <div id="createResponse" class="response"></div>
                </div>
            </div>
        </div>

        <!-- P2Pç½‘ç»œçŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸŒ P2Pç½‘ç»œçŠ¶æ€</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getP2PStatus()">åˆ·æ–°P2PçŠ¶æ€</button>
                <button class="button secondary" onclick="toggleP2PAutoRefresh()">è‡ªåŠ¨åˆ·æ–° (å…³)</button>
            </div>
            
            <div id="p2pStatusContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ</div>
                    <h3>P2Pç½‘ç»œçŠ¶æ€</h3>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–P2Pç½‘ç»œçŠ¶æ€</p>
                </div>
            </div>
        </div>

        <!-- å…¨çƒç½‘ç»œçŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸŒ å…¨çƒç½‘ç»œçŠ¶æ€</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getGlobalNetworkStatus()">åˆ·æ–°å…¨çƒçŠ¶æ€</button>
            </div>
            
            <div id="globalNetworkContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ</div>
                    <h3>å…¨çƒç½‘ç»œçŠ¶æ€</h3>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–å…¨çƒç½‘ç»œçŠ¶æ€</p>
                </div>
            </div>
        </div>

        <!-- ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸŒ ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getNetworkTopology()">åˆ·æ–°æ‹“æ‰‘ä¿¡æ¯</button>
            </div>
            
            <div id="topologyContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ</div>
                    <h3>ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯</h3>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯</p>
                </div>
            </div>
        </div>

        <!-- ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ”„ ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getRelayNodesInfo()">åˆ·æ–°ä¸­ç»§ä¿¡æ¯</button>
            </div>
            
            <div id="relayContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”„</div>
                    <h3>ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯</h3>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ æ¡£æ¡ˆç®¡ç†</h2>
            <div style="margin-bottom: 20px;">
                <button class="button" onclick="getUnifiedItems()">è·å–æ¡£æ¡ˆ</button>
                <button class="button secondary" onclick="getItemsByType('citizen')">è·å–å¸‚æ°‘æ¡£æ¡ˆ</button>
                <button class="button secondary" onclick="getItemsByType('pet')">è·å–å® ç‰©æ¡£æ¡ˆ</button>
                <button class="button secondary" onclick="getItemsByType('collection')">è·å–æ”¶è—é›†</button>
                <button class="button secondary" onclick="syncUnifiedItems()">åŒæ­¥ç½‘ç»œæ¡£æ¡ˆ</button>
            </div>
            
            <div id="itemsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <h3>æš‚æ— æ¡£æ¡ˆæ•°æ®</h3>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–æ¡£æ¡ˆåˆ—è¡¨</p>
                </div>
            </div>
        </div>

        <!-- æ¡£æ¡ˆä¿®æ”¹åˆ é™¤æ¨¡å— -->
        <div class="card">
            <h2>âœï¸ æ¡£æ¡ˆä¿®æ”¹ & åˆ é™¤</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">
                ğŸ” <strong>èº«ä»½éªŒè¯è¯´æ˜ï¼š</strong>
                <br>â€¢ å¯ä»¥ç›´æ¥ä¿®æ”¹/åˆ é™¤æœ¬èŠ‚ç‚¹åˆ›å»ºçš„æ¡£æ¡ˆ
                <br>â€¢ ä¿®æ”¹å…¶ä»–èŠ‚ç‚¹çš„æ¡£æ¡ˆéœ€è¦æä¾›åˆ›å»ºè€…çš„èŠ‚ç‚¹IDè¿›è¡ŒéªŒè¯
            </p>
            
            <!-- å½“å‰èŠ‚ç‚¹ä¿¡æ¯ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">ğŸ†”</span>
                    <div>
                        <strong>å½“å‰èŠ‚ç‚¹IDï¼š</strong>
                        <span id="currentNodeId" style="font-family: monospace; font-size: 0.9rem; color: #007bff;">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>

                            <!-- ä¿®æ”¹æ¡£æ¡ˆåŒºåŸŸ -->
                <div style="border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                    <h3 id="editArchiveTitle" style="color: #28a745; margin-bottom: 15px;">ğŸ“ ä¿®æ”¹æ¡£æ¡ˆ</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ¡£æ¡ˆIDï¼š</label>
                    <input type="text" id="editHeavenId" placeholder="è¾“å…¥è¦ä¿®æ”¹çš„æ¡£æ¡ˆID (ä¾‹: HT-2025-CIT12345678)" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠ‚ç‚¹IDéªŒè¯ (å¯é€‰)ï¼š</label>
                    <input type="text" id="editVerifyNodeId" placeholder="å¦‚æœè¦ä¿®æ”¹å…¶ä»–èŠ‚ç‚¹çš„æ¡£æ¡ˆï¼Œè¯·è¾“å…¥åˆ›å»ºè€…çš„èŠ‚ç‚¹ID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
                    <small style="color: #6c757d;">ğŸ’¡ æç¤ºï¼šä¿®æ”¹æœ¬èŠ‚ç‚¹åˆ›å»ºçš„æ¡£æ¡ˆæ— éœ€å¡«å†™æ­¤å­—æ®µ</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ¡£æ¡ˆç±»å‹ï¼š</label>
                        <select id="editTier" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="citizen">ğŸ‘¤ å¸‚æ°‘æ¡£æ¡ˆ</option>
                            <option value="pet">ğŸ• å® ç‰©æ¡£æ¡ˆ</option>
                            <option value="collection">ğŸ“š æ”¶è—é›†</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">è®¿é—®æƒé™ï¼š</label>
                        <select id="editAccess" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="public">ğŸŒ å…¬å¼€</option>
                            <option value="private">ğŸ”’ ç§æœ‰</option>
                            <option value="restricted">âš ï¸ å—é™</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å§“å/åç§°ï¼š</label>
                    <input type="text" id="editNameInput" placeholder="è¯·è¾“å…¥å§“åæˆ–åç§°" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">åœ°åŒºï¼š</label>
                    <input type="text" id="editRegionInput" placeholder="å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ—¶ä»£ï¼š</label>
                    <input type="text" id="editEraInput" placeholder="å¦‚ï¼šç°ä»£ã€æ°‘å›½" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)ï¼š</label>
                    <input type="text" id="editTagsInput" placeholder="å¦‚ï¼šå·¥ç¨‹å¸ˆ,çˆ¶äº²,æ‘„å½±çˆ±å¥½è€…" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="button" onclick="loadItemForEdit()" style="background: #17a2b8;">ğŸ“¥ åŠ è½½æ¡£æ¡ˆ</button>
                    <button class="button" onclick="updateItem()" style="background: #28a745;">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>

                            <!-- åˆ é™¤æ¡£æ¡ˆåŒºåŸŸ -->
                <div style="border: 2px solid #dc3545; border-radius: 10px; padding: 20px;">
                    <h3 id="deleteArchiveTitle" style="color: #dc3545; margin-bottom: 15px;">ğŸ—‘ï¸ åˆ é™¤æ¡£æ¡ˆ</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ¡£æ¡ˆIDï¼š</label>
                    <input type="text" id="deleteHeavenId" placeholder="è¾“å…¥è¦åˆ é™¤çš„æ¡£æ¡ˆID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠ‚ç‚¹IDéªŒè¯ (å¯é€‰)ï¼š</label>
                    <input type="text" id="deleteVerifyNodeId" placeholder="å¦‚æœè¦åˆ é™¤å…¶ä»–èŠ‚ç‚¹çš„æ¡£æ¡ˆï¼Œè¯·è¾“å…¥åˆ›å»ºè€…çš„èŠ‚ç‚¹ID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
                    <small style="color: #6c757d;">ğŸ’¡ æç¤ºï¼šåˆ é™¤æœ¬èŠ‚ç‚¹åˆ›å»ºçš„æ¡£æ¡ˆæ— éœ€å¡«å†™æ­¤å­—æ®µ</small>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="button secondary" onclick="previewDeleteItem()" style="background: #6c757d;">ğŸ‘ï¸ é¢„è§ˆæ¡£æ¡ˆ</button>
                    <button class="button" onclick="deleteItem()" style="background: #dc3545;">ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>

            <!-- æ“ä½œç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="editDeleteResult" style="margin-top: 20px;"></div>
        </div>

        <div class="card">
            <h2>ğŸ”— æœåŠ¡åœ°å€</h2>
            <p><strong>åç«¯ API:</strong> <a href="http://localhost:8080" target="_blank">http://localhost:8080</a> <span class="status online" id="apiStatus">åœ¨çº¿</span></p>
            <p><strong>MinIO æ§åˆ¶å°:</strong> <a href="http://localhost:9001" target="_blank">http://localhost:9001</a> (ç”¨æˆ·å/å¯†ç : minioadmin)</p>
            <p><strong>NATS ç›‘æ§:</strong> <a href="http://localhost:8222" target="_blank">http://localhost:8222</a></p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    return { 
                        success: false, 
                        error: `æœåŠ¡å™¨è¿”å›éJSONå“åº”: ${text.substring(0, 100)}...`,
                        status: response.status 
                    };
                }
                
                const result = await response.json();
                console.log('API Response:', { endpoint, status: response.status, result });
                
                // å¦‚æœåç«¯è¿”å›çš„æ•°æ®åŒ…å« success å­—æ®µï¼Œç›´æ¥è¿”å›
                // å¦åˆ™åŒ…è£…æˆæ ‡å‡†æ ¼å¼
                if (result.hasOwnProperty('success')) {
                    return { success: response.ok, data: result, status: response.status };
                } else {
                    return { success: response.ok, data: { data: result, success: true }, status: response.status };
                }
            } catch (error) {
                console.error('API Call Error:', { endpoint, error });
                return { success: false, error: error.message, status: 'network_error' };
            }
        }

        async function checkHealth() {
            try {
                const result = await apiCall('/api/v1/health');
                console.log('å¥åº·æ£€æŸ¥å“åº”:', result); // è°ƒè¯•æ—¥å¿—
                
                if (result.success && result.data) {
                    document.getElementById('systemResponse').textContent = JSON.stringify(result.data, null, 2);
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    const statusElement = document.getElementById('apiStatus');
                    if (statusElement) {
                        statusElement.textContent = 'åœ¨çº¿';
                        statusElement.className = 'status online';
                    }
                } else {
                    document.getElementById('systemResponse').textContent = JSON.stringify(result, null, 2);
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    const statusElement = document.getElementById('apiStatus');
                    if (statusElement) {
                        statusElement.textContent = 'ç¦»çº¿';
                        statusElement.className = 'status offline';
                    }
                }
            } catch (error) {
                console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                document.getElementById('systemResponse').textContent = `å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`;
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    statusElement.textContent = 'é”™è¯¯';
                    statusElement.className = 'status offline';
                }
            }
        }

        async function getStats() {
            const result = await apiCall('/api/v1/stats');
            document.getElementById('systemResponse').textContent = JSON.stringify(result.data, null, 2);
        }

        async function getTLogStatus() {
            const result = await apiCall('/api/v1/tlog/sth');
            document.getElementById('systemResponse').textContent = JSON.stringify(result.data, null, 2);
        }

        async function getAllItems() {
            await loadItems('/api/v1/p2p/items/');
        }

        async function getItemsByType(tier) {
            await loadItems(`/api/v1/p2p/items/?tier=${tier}`, `${tier}æ¡£æ¡ˆ`);
        }

        // loadItemså‡½æ•°å·²ç§»åŠ¨åˆ°ä¸‹æ–¹ï¼Œæ”¯æŒæ•°æ®æºæ ‡è¯†

        // displayItemså‡½æ•°å·²ç§»åŠ¨åˆ°ä¸‹æ–¹ï¼Œæ”¯æŒæ•°æ®æºæ ‡è¯†

        function createItemCard(item) {
            const tierIcons = {
                citizen: 'ğŸ‘¤',
                pet: 'ğŸ•',
                collection: 'ğŸ“š'
            };

            const accessIcons = {
                public: 'ğŸŒ',
                link: 'ğŸ”—',
                private: 'ğŸ”’'
            };

            const accessLabels = {
                public: 'å…¬å¼€',
                link: 'ä»…é™é“¾æ¥',
                private: 'ç§å¯†'
            };

            const tierLabels = {
                citizen: 'å¸‚æ°‘æ¡£æ¡ˆ',
                pet: 'å® ç‰©æ¡£æ¡ˆ',
                collection: 'æ”¶è—é›†'
            };

            const tags = item.meta.tags ? item.meta.tags.map(tag => 
                `<span class="tag">${tag}</span>`
            ).join('') : '';

            const createdDate = new Date(item.created_at).toLocaleString('zh-CN');

            return `
                <div class="item-card ${item.tier}">
                    <div class="access-badge ${item.access}">
                        ${accessIcons[item.access]} ${accessLabels[item.access]}
                    </div>
                    
                    <div class="item-header">
                        <div class="item-icon ${item.tier}">
                            ${tierIcons[item.tier]}
                        </div>
                        <div>
                            <div class="item-title">${item.meta.name || 'æœªå‘½å'}</div>
                            <div class="item-id">${item.heaven_id}</div>
                        </div>
                    </div>
                    
                    <div class="item-meta">
                        <div class="meta-row">
                            <span class="meta-icon">ğŸ“</span>
                            <span>${item.meta.region || 'æœªçŸ¥åœ°åŒº'}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-icon">ğŸ•</span>
                            <span>${item.meta.era || 'æœªçŸ¥æ—¶ä»£'}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-icon">ğŸ“‚</span>
                            <span>${tierLabels[item.tier]}</span>
                        </div>
                    </div>
                    
                    ${tags ? `<div class="item-tags">${tags}</div>` : ''}
                    
                    <div class="item-footer">
                        <span>åˆ›å»ºæ—¶é—´: ${createdDate}</span>
                    </div>
                </div>
            `;
        }

        async function createItem() {
            console.log('ğŸš€ å¼€å§‹åˆ›å»ºæ¡£æ¡ˆ...'); // è°ƒè¯•æ—¥å¿—
            const tier = document.getElementById('tierSelect').value;
            const name = document.getElementById('nameInput').value;
            const region = document.getElementById('regionInput').value;
            const era = document.getElementById('eraInput').value;
            const tags = document.getElementById('tagsInput').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const access = document.getElementById('accessSelect').value;

            console.log('ğŸ“ è¡¨å•æ•°æ®:', { tier, name, region, era, tags, access }); // è°ƒè¯•æ—¥å¿—

            if (!name) {
                alert('è¯·è¾“å…¥å§“åæˆ–åç§°');
                return;
            }

            const data = {
                tier,
                owner_pubkey: 'ed25519:demo_key',
                meta: {
                    name,
                    region: region || 'æœªçŸ¥',
                    era: era || 'ç°ä»£',
                    tags
                },
                access
            };

            const result = await apiCall('/api/v1/p2p/items/', 'POST', data);
            console.log('ğŸ“¤ åˆ›å»ºæ¡£æ¡ˆAPIå“åº”:', result); // è°ƒè¯•æ—¥å¿—
            document.getElementById('createResponse').textContent = JSON.stringify(result, null, 2);
            
            if (result.success) {
                // æ¸…ç©ºè¡¨å•
                document.getElementById('nameInput').value = '';
                document.getElementById('regionInput').value = '';
                document.getElementById('eraInput').value = '';
                document.getElementById('tagsInput').value = '';
                
                // åˆ·æ–°æ¡£æ¡ˆåˆ—è¡¨
                getUnifiedItems();
            }
        }

        // P2PçŠ¶æ€ç›¸å…³åŠŸèƒ½
        let p2pAutoRefresh = false;
        let p2pRefreshInterval = null;

        async function getP2PStatus() {
            const container = document.getElementById('p2pStatusContainer');
            container.innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨è·å–P2Pç½‘ç»œçŠ¶æ€...</div>';
            
            try {
                const response = await apiCall('/api/v1/p2p/status');
                if (response.success) {
                    // æ”¯æŒä¸¤ç§æ•°æ®ç»“æ„
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayP2PStatus(data);
                    
                    // åŒæ—¶æ›´æ–°å…¶ä»–ç½‘ç»œçŠ¶æ€ä¿¡æ¯
                    console.log('ğŸ”„ å¼€å§‹æ›´æ–°å…¶ä»–ç½‘ç»œçŠ¶æ€...');
                    await Promise.all([
                        getGlobalNetworkStatus(),
                        getNetworkTopology(),
                        getRelayNodesInfo()
                    ]);
                    console.log('âœ… æ‰€æœ‰ç½‘ç»œçŠ¶æ€æ›´æ–°å®Œæˆ');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âŒ</div>
                            <h3>P2PçŠ¶æ€è·å–å¤±è´¥</h3>
                            <p>HTTPçŠ¶æ€: ${response.status}</p>
                            <p>é”™è¯¯ä¿¡æ¯: ${response.error || 'APIè°ƒç”¨å¤±è´¥'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>P2PçŠ¶æ€è·å–å¤±è´¥</h3>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ–°å¢ï¼šè·å–å…¨çƒç½‘ç»œçŠ¶æ€
        async function getGlobalNetworkStatus() {
            try {
                const response = await apiCall('/api/v1/global/status');
                if (response.success) {
                    // æ”¯æŒä¸¤ç§æ•°æ®ç»“æ„
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayGlobalNetworkStatus(data);
                } else {
                    console.error('è·å–å…¨çƒç½‘ç»œçŠ¶æ€å¤±è´¥:', response.error);
                }
            } catch (error) {
                console.error('è·å–å…¨çƒç½‘ç»œçŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šè·å–ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯
        async function getNetworkTopology() {
            try {
                const response = await apiCall('/api/v1/global/topology');
                if (response.success) {
                    // æ”¯æŒä¸¤ç§æ•°æ®ç»“æ„
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayNetworkTopology(data);
                } else {
                    console.error('è·å–ç½‘ç»œæ‹“æ‰‘å¤±è´¥:', response.error);
                }
            } catch (error) {
                console.error('è·å–ç½‘ç»œæ‹“æ‰‘å¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šè·å–ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯
        async function getRelayNodesInfo() {
            try {
                const response = await apiCall('/api/v1/global/relay');
                if (response.success) {
                    // æ”¯æŒä¸¤ç§æ•°æ®ç»“æ„
                    let data = response.data;
                    if (response.data.data) {
                        data = response.data.data;
                    }
                    displayRelayNodesInfo(data);
                } else {
                    console.error('è·å–ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥:', response.error);
                }
            } catch (error) {
                console.error('è·å–ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºå…¨çƒç½‘ç»œçŠ¶æ€
        function displayGlobalNetworkStatus(data) {
            const container = document.getElementById('globalNetworkContainer');
            if (!container) {
                console.warn('globalNetworkContainerå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            try {
                console.log('å…¨çƒç½‘ç»œçŠ¶æ€æ•°æ®:', data);
                
                container.innerHTML = `
                    <div class="global-network-status">
                        <h3>ğŸŒ å…¨çƒç½‘ç»œçŠ¶æ€</h3>
                        <div class="status-item">
                            <span class="status-label">ç½‘ç»œçŠ¶æ€</span>
                            <span class="status-value">${data.network_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å‘ç°çŠ¶æ€</span>
                            <span class="status-value">${data.discovery_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§åŠŸèƒ½</span>
                            <span class="status-value">${data.relay_enabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åœ°ç†ä½ç½®æ„ŸçŸ¥</span>
                            <span class="status-value">${data.geo_aware ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ€»èŠ‚ç‚¹æ•°</span>
                            <span class="status-value">${data.total_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å·²è¿æ¥èŠ‚ç‚¹</span>
                            <span class="status-value">${data.connected_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç›‘å¬åœ°å€</span>
                            <span class="status-value">${(data.listen_addrs || []).length} ä¸ª</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¤–éƒ¨åœ°å€</span>
                            <span class="status-value">${(data.external_addrs || []).length} ä¸ª</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æœ€å¤§è¿æ¥æ•°</span>
                            <span class="status-value">${data.max_peers || 'unlimited'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åŒæ­¥é—´éš”</span>
                            <span class="status-value">${data.sync_interval || '60s'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ•°æ®åˆ†ç‰‡å¤§å°</span>
                            <span class="status-value">${(data.chunk_size || 1048576) / 1024 / 1024}MB</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¤åˆ¶å› å­</span>
                            <span class="status-value">${data.replication_factor || 3}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('æ˜¾ç¤ºå…¨çƒç½‘ç»œçŠ¶æ€å¤±è´¥:', error);
                container.innerHTML = '<div class="error">æ˜¾ç¤ºå…¨çƒç½‘ç»œçŠ¶æ€å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºç½‘ç»œæ‹“æ‰‘ä¿¡æ¯
        function displayNetworkTopology(data) {
            const container = document.getElementById('topologyContainer');
            if (!container) {
                console.warn('topologyContainerå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            try {
                console.log('ç½‘ç»œæ‹“æ‰‘æ•°æ®:', data);
                
                // è®¡ç®—ç½‘ç»œå¥åº·åº¦é¢œè‰²
                const healthColor = data.network_health === 'excellent' ? '#28a745' : 
                                   data.network_health === 'good' ? '#17a2b8' :
                                   data.network_health === 'fair' ? '#ffc107' : 
                                   data.network_health === 'isolated' ? '#6c757d' : '#dc3545';
                
                // è®¡ç®—ç½‘ç»œå¯†åº¦è¿›åº¦æ¡
                const densityPercent = parseFloat(data.network_density) || 0;
                
                container.innerHTML = `
                    <div class="network-topology">
                        <h3>ğŸŒ ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯</h3>
                        <div class="status-item">
                            <span class="status-label">ç½‘ç»œå¥åº·åº¦</span>
                            <span class="status-value" style="color: ${healthColor}; font-weight: bold;">
                                ${data.network_health || 'unknown'}
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ‹“æ‰‘ç±»å‹</span>
                            <span class="status-value">${data.topology_type || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ€»èŠ‚ç‚¹æ•°</span>
                            <span class="status-value">${data.total_nodes || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å·²è¿æ¥èŠ‚ç‚¹</span>
                            <span class="status-value">${data.connected_nodes || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç½‘ç»œå¯†åº¦</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${densityPercent}%; background: ${healthColor};"></div>
                                <span class="progress-text">${data.network_density || '0%'}</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">è·¯ç”±æ•ˆç‡</span>
                            <span class="status-value">${data.routing_efficiency || '0%'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æœ€åæ›´æ–°</span>
                            <span class="status-value">${data.last_updated || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ‹“æ‰‘ç‰¹æ€§</span>
                            <span class="status-value">${(data.topology_features || []).join(', ') || 'æ— '}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('æ˜¾ç¤ºç½‘ç»œæ‹“æ‰‘ä¿¡æ¯å¤±è´¥:', error);
                container.innerHTML = '<div class="error">æ˜¾ç¤ºç½‘ç»œæ‹“æ‰‘ä¿¡æ¯å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯
        function displayRelayNodesInfo(data) {
            const container = document.getElementById('relayContainer');
            if (!container) {
                console.warn('relayContainerå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            try {
                container.innerHTML = `
                    <div class="relay-nodes-info">
                        <h3>ğŸ”„ ä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯</h3>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§èŠ‚ç‚¹æ•°</span>
                            <span class="status-value">${data.relay_count || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§çŠ¶æ€</span>
                            <span class="status-value">${data.relay_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æœ€åæ›´æ–°</span>
                            <span class="status-value">${data.last_updated || 'unknown'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('æ˜¾ç¤ºä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥:', error);
                container.innerHTML = '<div class="error">æ˜¾ç¤ºä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥</div>';
            }
        }

        function displayP2PStatus(data) {
            const container = document.getElementById('p2pStatusContainer');
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('P2P Status Data:', data);
            
            // å…¼å®¹æ–°æ—§ä¸¤ç§æ ¼å¼
            const nodeId = data.node?.id || data.node_id || 'æœªçŸ¥';
            const status = data.status || 'unknown';
            const port = data.node?.port || 8080;
            const protocolVersion = data.node?.protocol_version || '2.0.0-global';
            
            // è¿æ¥ä¿¡æ¯ - å…¼å®¹æ–°æ—§æ ¼å¼
            const connectedPeers = data.connections?.bootstrap_nodes?.connected || 
                                  data.connections?.peers?.connected || 
                                  data.connected_peers || 0;
            const totalPeers = data.connections?.bootstrap_nodes?.total || 
                              data.connections?.peers?.total || 
                              data.total_peers || 0;
            const discoveredPeers = data.connections?.peers?.discovered || 0;
            const iheavenNodes = data.connections?.peers?.iheaven_nodes || 0;
            
            const successRate = totalPeers > 0 ? `${Math.round(connectedPeers / totalPeers * 100)}%` : '0%';
            const progressPercent = totalPeers > 0 ? (connectedPeers / totalPeers * 100) : 0;
            
            const statusClass = status === 'healthy' || status === 'active' ? 'healthy' : 
                               status === 'starting' ? 'starting' : 'offline';
            
            container.innerHTML = `
                <div class="p2p-status">
                    <!-- èŠ‚ç‚¹ä¿¡æ¯ -->
                    <div class="p2p-section">
                        <h3>ğŸ†” èŠ‚ç‚¹ä¿¡æ¯</h3>
                        <div class="status-item">
                            <span class="status-label">çŠ¶æ€</span>
                            <span class="status-badge status-${statusClass}">${status}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">èŠ‚ç‚¹ID</span>
                            <div class="node-id" style="word-break: break-all; font-family: monospace; font-size: 0.8rem;">${nodeId}</div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç›‘å¬ç«¯å£</span>
                            <span class="status-value">${port}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åè®®ç‰ˆæœ¬</span>
                            <span class="status-value">${protocolVersion}</span>
                        </div>
                    </div>

                    <!-- ç½‘ç»œè¿æ¥ -->
                    <div class="p2p-section">
                        <h3>ğŸ”— ç½‘ç»œè¿æ¥</h3>
                        <div class="status-item">
                            <span class="status-label">è¿æ¥æˆåŠŸç‡</span>
                            <span class="status-value">${successRate}</span>
                        </div>
                        <div class="progress-bar" style="background: #e9ecef; height: 8px; border-radius: 4px; margin: 8px 0;">
                            <div class="progress-fill" style="background: #007bff; height: 100%; border-radius: 4px; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å·²è¿æ¥/æ€»æ•°</span>
                            <span class="status-value">${connectedPeers}/${totalPeers}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å‘ç°çš„èŠ‚ç‚¹</span>
                            <span class="status-value">${discoveredPeers}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">iHeavenèŠ‚ç‚¹</span>
                            <span class="status-value">${iheavenNodes}</span>
                        </div>
                    </div>

                    <!-- ç½‘ç»œåè®® -->
                    <div class="p2p-section">
                        <h3>ğŸ“¡ ç½‘ç»œåè®®</h3>
                        <div class="status-item">
                            <span class="status-label">DHTçŠ¶æ€</span>
                            <span class="status-value">${data.dht_status || 'active'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å‘ç°çŠ¶æ€</span>
                            <span class="status-value">${data.discovery_status || 'running'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åŒæ­¥çŠ¶æ€</span>
                            <span class="status-value">${data.sync_status || 'active'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- æ–°å¢ï¼šå…¨çƒç½‘ç»œçŠ¶æ€æŒ‰é’® -->
                <div style="text-align: center; margin-top: 20px;">
                                    <button class="button" onclick="refreshAllNetworkStatus()">
                    ğŸ”„ åˆ·æ–°æ‰€æœ‰ç½‘ç»œçŠ¶æ€
                </button>
                <button class="button secondary" onclick="startRealTimeMonitoring()">
                    ğŸ• å¯åŠ¨å®æ—¶ç›‘æ§
                </button>
                <button class="button secondary" onclick="stopRealTimeMonitoring()">
                    â¹ï¸ åœæ­¢å®æ—¶ç›‘æ§
                </button>
                <div id="refreshInfo" class="refresh-info">
                    <span>ğŸ• æœ€ååˆ·æ–°: æœªåˆ·æ–°</span>
                    <span>â±ï¸ è‡ªåŠ¨åˆ·æ–°: å…³é—­</span>
                </div>
                </div>
            `;
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºå…¨çƒç½‘ç»œçŠ¶æ€
        function displayGlobalNetworkStatus(data) {
            const container = document.getElementById('globalNetworkContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="p2p-status">
                    <!-- å…¨çƒç½‘ç»œæ¦‚è§ˆ -->
                    <div class="p2p-section">
                        <h3>ğŸŒ å…¨çƒç½‘ç»œæ¦‚è§ˆ</h3>
                        <div class="status-item">
                            <span class="status-label">ç½‘ç»œçŠ¶æ€</span>
                            <span class="status-badge status-${data.network_status === 'active' ? 'healthy' : 'offline'}">${data.network_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å‘ç°çŠ¶æ€</span>
                            <span class="status-badge status-${data.discovery_status === 'running' ? 'healthy' : 'offline'}">${data.discovery_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§åŠŸèƒ½</span>
                            <span class="status-value">${data.relay_enabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åœ°ç†ä½ç½®æ„ŸçŸ¥</span>
                            <span class="status-value">${data.geo_aware ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</span>
                        </div>
                    </div>

                    <!-- èŠ‚ç‚¹ç»Ÿè®¡ -->
                    <div class="p2p-section">
                        <h3>ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡</h3>
                        <div class="status-item">
                            <span class="status-label">æ€»èŠ‚ç‚¹æ•°</span>
                            <span class="status-value">${data.total_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å·²è¿æ¥èŠ‚ç‚¹</span>
                            <span class="status-value">${data.connected_peers || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç›‘å¬åœ°å€</span>
                            <span class="status-value">${(data.listen_addrs || []).length} ä¸ª</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¤–éƒ¨åœ°å€</span>
                            <span class="status-value">${(data.external_addrs || []).length} ä¸ª</span>
                        </div>
                    </div>

                    <!-- ç½‘ç»œé…ç½® -->
                    <div class="p2p-section">
                        <h3>âš™ï¸ ç½‘ç»œé…ç½®</h3>
                        <div class="status-item">
                            <span class="status-label">æœ€å¤§è¿æ¥æ•°</span>
                            <span class="status-value">${data.max_peers || 'unlimited'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åŒæ­¥é—´éš”</span>
                            <span class="status-value">${data.sync_interval || '60s'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ•°æ®åˆ†ç‰‡å¤§å°</span>
                            <span class="status-value">${data.chunk_size ? Math.round(data.chunk_size / 1024 / 1024) + 'MB' : '1MB'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¤åˆ¶å› å­</span>
                            <span class="status-value">${data.replication_factor || 3}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ç½‘ç»œæ‹“æ‰‘ä¿¡æ¯æ˜¾ç¤ºå‡½æ•°å·²ç§»åŠ¨åˆ°ä¸‹æ–¹ï¼Œæ”¯æŒæ­£ç¡®çš„æ•°æ®ç»“æ„

        // æ–°å¢ï¼šæ˜¾ç¤ºä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯
        function displayRelayNodesInfo(data) {
            const container = document.getElementById('relayContainer');
            if (!container) {
                console.warn('relayContainerå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            try {
                console.log('ä¸­ç»§èŠ‚ç‚¹æ•°æ®:', data);
                
                container.innerHTML = `
                    <div class="p2p-section">
                        <h3>ğŸ”„ ä¸­ç»§èŠ‚ç‚¹</h3>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§çŠ¶æ€</span>
                            <span class="status-value">${data.relay_status || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§èŠ‚ç‚¹æ•°</span>
                            <span class="status-value">${data.total_relay_nodes || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å®¢æˆ·ç«¯æ•°</span>
                            <span class="status-value">${data.total_clients || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ€»å®¹é‡</span>
                            <span class="status-value">${data.total_capacity || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å½“å‰è´Ÿè½½</span>
                            <span class="status-value">${data.total_load || 0}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å®¹é‡ä½¿ç”¨ç‡</span>
                            <span class="status-value">${data.capacity_usage || '0%'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§æ•ˆç‡</span>
                            <span class="status-value">${data.relay_efficiency || '0%'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¹³å‡åˆ†æ•°</span>
                            <span class="status-value">${data.average_score ? data.average_score.toFixed(2) : 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æœ€åæ›´æ–°</span>
                            <span class="status-value">${data.last_updated || 'unknown'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­ç»§ç‰¹æ€§</span>
                            <span class="status-value">${(data.relay_features || []).join(', ') || 'æ— '}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æˆåŠŸç‡</span>
                            <span class="status-value">${data.relay_stats?.success_rate || 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¹³å‡å“åº”æ—¶é—´</span>
                            <span class="status-value">${data.relay_stats?.avg_response_time || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('æ˜¾ç¤ºä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥:', error);
                container.innerHTML = '<div class="error">æ˜¾ç¤ºä¸­ç»§èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šåˆ·æ–°æ‰€æœ‰ç½‘ç»œçŠ¶æ€
        async function refreshAllNetworkStatus() {
            console.log('ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰ç½‘ç»œçŠ¶æ€...');
            
            try {
                // å¹¶è¡Œè·å–æ‰€æœ‰çŠ¶æ€
                await Promise.all([
                    getP2PStatus(),
                    getGlobalNetworkStatus(),
                    getNetworkTopology(),
                    getRelayNodesInfo()
                ]);
                
                console.log('âœ… æ‰€æœ‰ç½‘ç»œçŠ¶æ€åˆ·æ–°å®Œæˆ');
            } catch (error) {
                console.error('åˆ·æ–°ç½‘ç»œçŠ¶æ€å¤±è´¥:', error);
            }
        }

        function toggleP2PAutoRefresh() {
            const button = event.target;
            
            if (p2pAutoRefresh) {
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                p2pAutoRefresh = false;
                clearInterval(p2pRefreshInterval);
                button.textContent = 'è‡ªåŠ¨åˆ·æ–° (å…³)';
                button.classList.remove('button');
                button.classList.add('button', 'secondary');
            } else {
                // å¼€å¯è‡ªåŠ¨åˆ·æ–°
                p2pAutoRefresh = true;
                p2pRefreshInterval = setInterval(getP2PStatus, 10000); // æ¯10ç§’åˆ·æ–°
                button.textContent = 'è‡ªåŠ¨åˆ·æ–° (å¼€)';
                button.classList.remove('secondary');
                
                // ç«‹å³åˆ·æ–°ä¸€æ¬¡
                getP2PStatus();
            }
        }

        // ç»Ÿä¸€æ¡£æ¡ˆç®¡ç†å‡½æ•°
        async function getUnifiedItems() {
            console.log('ğŸ” å¼€å§‹è·å–ç»Ÿä¸€æ¡£æ¡ˆ...');
            await loadItems('/api/v1/p2p/items/', 'ç»Ÿä¸€æ¡£æ¡ˆ');
        }

        async function syncUnifiedItems() {
            try {
                const response = await apiCall('/api/v1/p2p/items/sync', 'POST');
                if (response.success) {
                    alert('æ¡£æ¡ˆç½‘ç»œåŒæ­¥å·²å¯åŠ¨');
                    // åˆ·æ–°æ¡£æ¡ˆåˆ—è¡¨
                    getUnifiedItems();
                } else {
                    alert('åŒæ­¥å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // createUnifiedItemå‡½æ•°å·²åˆ é™¤ï¼Œä½¿ç”¨createItemå‡½æ•°æ›¿ä»£

        // ä¿®æ”¹åŸæœ‰çš„loadItemså‡½æ•°ï¼Œæ”¯æŒæ•°æ®æºæ ‡è¯†
        async function loadItems(endpoint, sourceLabel = 'æ¡£æ¡ˆ') {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨åŠ è½½' + sourceLabel + '...</div>';
            
            try {
                const response = await apiCall(endpoint);
                console.log('loadItems response:', response); // è°ƒè¯•æ—¥å¿—
                
                if (response.success && response.data) {
                    // æ£€æŸ¥response.dataçš„ç»“æ„
                    console.log('APIå“åº”æ•°æ®ç»“æ„:', response.data); // è°ƒè¯•æ—¥å¿—
                    const actualData = response.data.data || response.data;
                    console.log('å®é™…æ•°æ®:', actualData); // è°ƒè¯•æ—¥å¿—
                    if (Array.isArray(actualData) && actualData.length > 0) {
                        displayItems(actualData, sourceLabel);
                    } else if (actualData.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“‹</div>
                                <h3>æš‚æ— ${sourceLabel}æ•°æ®</h3>
                                <p>æ•°æ®æº: ${response.source || 'æœªçŸ¥'}</p>
                                <p>APIå“åº”æ­£å¸¸ï¼Œä½†æ²¡æœ‰æ•°æ®</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">â“</div>
                                <h3>æ•°æ®æ ¼å¼å¼‚å¸¸</h3>
                                <p>æ•°æ®æº: ${response.source || 'æœªçŸ¥'}</p>
                                <p>å“åº”æ•°æ®ä¸æ˜¯æ•°ç»„æ ¼å¼</p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âŒ</div>
                            <h3>APIå“åº”å¤±è´¥</h3>
                            <p>é”™è¯¯: ${response.error || 'APIè¿”å›success=false'}</p>
                            <p>çŠ¶æ€: ${response.status || 'æœªçŸ¥'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('loadItems error:', error); // è°ƒè¯•æ—¥å¿—
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>${sourceLabel}åŠ è½½å¤±è´¥</h3>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <p>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</p>
                    </div>
                `;
            }
        }

        // ä¿®æ”¹displayItemså‡½æ•°ï¼Œæ˜¾ç¤ºæ•°æ®æºä¿¡æ¯
        function displayItems(items, sourceLabel = 'æ¡£æ¡ˆ') {
            const container = document.getElementById('itemsContainer');
            
            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <h3>æš‚æ— ${sourceLabel}æ•°æ®</h3>
                    </div>
                `;
                return;
            }

            const tierIcons = {
                'citizen': 'ğŸ‘¤',
                'pet': 'ğŸ•',
                'collection': 'ğŸ“š'
            };

            let itemsHTML = `
                <div class="items-header" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <h3>ğŸ“Š ${sourceLabel}æ•°æ® (å…± ${items.length} ä¸ª)</h3>
                    <p style="font-size: 0.9rem; color: #6c757d;">
                        æ•°æ®æº: ${items[0]?.source || 'æœªçŸ¥'} | 
                        æœ€åæ›´æ–°: ${new Date().toLocaleString()}
                    </p>
                </div>
                <div class="items-grid">
            `;
            
            items.forEach(item => {
                const meta = item.meta || {};
                const tags = meta.tags || [];
                const tagsHTML = tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                
                itemsHTML += `
                    <div class="item-card ${item.tier}">
                        <div class="item-decoration"></div>
                        
                        <div class="item-header">
                            <div class="item-icon ${item.tier}">
                                ${tierIcons[item.tier]}
                            </div>
                            <div>
                                <div class="item-title">${meta.name || 'æœªå‘½å'}</div>
                                <div class="item-id">${item.heaven_id}</div>
                            </div>
                        </div>

                        <div class="item-meta">
                            <div class="meta-row">
                                <span class="meta-icon">ğŸŒ</span>
                                åœ°åŒº: ${meta.region || 'æœªçŸ¥'}
                            </div>
                            <div class="meta-row">
                                <span class="meta-icon">â°</span>
                                æ—¶ä»£: ${meta.era || 'æœªçŸ¥'}
                            </div>
                            <div class="meta-row">
                                <span class="meta-icon">ğŸ”‘</span>
                                è®¿é—®: <span class="access-badge ${item.access}">${item.access}</span>
                            </div>
                            ${item.source ? `
                            <div class="meta-row">
                                <span class="meta-icon">ğŸ’¾</span>
                                æ¥æº: <span style="font-family: monospace; font-size: 0.8rem;">${item.source}</span>
                            </div>
                            ` : ''}

                        </div>

                        ${tagsHTML ? `<div class="item-tags">${tagsHTML}</div>` : ''}

                        <div class="item-footer">
                            åˆ›å»ºæ—¶é—´: ${new Date(item.created_at).toLocaleString()}
                            ${item.version ? ` | ç‰ˆæœ¬: v${item.version}` : ''}
                        </div>
                        
                        <div class="item-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button class="button" onclick="fillEditForm('${item.heaven_id}')" 
                                    style="background: #28a745; font-size: 0.85rem; padding: 8px 12px;">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="button" onclick="fillDeleteForm('${item.heaven_id}')" 
                                    style="background: #dc3545; font-size: 0.85rem; padding: 8px 12px;">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>

                        </div>
                    </div>
                `;
            });
            
            itemsHTML += '</div>';
            container.innerHTML = itemsHTML;
        }

        // è·å–å½“å‰èŠ‚ç‚¹IDå¹¶æ˜¾ç¤º
        async function loadCurrentNodeId() {
            try {
                const response = await apiCall('/api/v1/p2p/status');
                console.log('èŠ‚ç‚¹IDå“åº”:', response); // è°ƒè¯•æ—¥å¿—
                
                // æ£€æŸ¥å“åº”ç»“æ„
                if (response.success && response.data) {
                    console.log('å“åº”æ•°æ®:', response.data);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰nodeå­—æ®µ - æ”¯æŒä¸¤ç§æ•°æ®ç»“æ„
                    let nodeData = response.data;
                    if (response.data.data && response.data.data.node) {
                        // å¦‚æœæ•°æ®åµŒå¥—åœ¨ data.data ä¸­
                        nodeData = response.data.data;
                    }
                    
                    if (nodeData.node && nodeData.node.id) {
                        const nodeId = nodeData.node.id;
                        console.log('è·å–åˆ°èŠ‚ç‚¹ID:', nodeId);
                        document.getElementById('currentNodeId').textContent = nodeId;
                        return nodeId;
                    } else {
                        console.error('å“åº”ä¸­ç¼ºå°‘nodeå­—æ®µæˆ–node.id:', nodeData);
                        document.getElementById('currentNodeId').textContent = 'èŠ‚ç‚¹ä¿¡æ¯ç¼ºå¤±';
                        return null;
                    }
                } else {
                    console.error('APIå“åº”å¤±è´¥:', response);
                    document.getElementById('currentNodeId').textContent = 'APIå“åº”å¤±è´¥';
                    return null;
                }
            } catch (error) {
                console.error('è·å–èŠ‚ç‚¹IDå¤±è´¥:', error);
                document.getElementById('currentNodeId').textContent = 'è·å–å¤±è´¥';
                return null;
            }
        }

        // åŠ è½½æ¡£æ¡ˆç”¨äºç¼–è¾‘
        async function loadItemForEdit() {
            const heavenId = document.getElementById('editHeavenId').value.trim();
            
            if (!heavenId) {
                showEditDeleteResult('error', 'è¯·è¾“å…¥æ¡£æ¡ˆID');
                return;
            }

            try {
                const response = await apiCall(`/api/v1/p2p/items/${heavenId}`);
                
                if (response.success && response.data) {
                    const item = response.data;
                    
                    // å¡«å……è¡¨å•
                    document.getElementById('editTier').value = item.tier;
                    document.getElementById('editAccess').value = item.access;
                    
                    // å¡«å……metaå­—æ®µçš„å„ä¸ªéƒ¨åˆ†
                    document.getElementById('editNameInput').value = item.meta.name || '';
                    document.getElementById('editRegionInput').value = item.meta.region || '';
                    document.getElementById('editEraInput').value = item.meta.era || '';
                    
                    // å¤„ç†æ ‡ç­¾æ•°ç»„
                    if (item.meta.tags && Array.isArray(item.meta.tags)) {
                        document.getElementById('editTagsInput').value = item.meta.tags.join(', ');
                    } else {
                        document.getElementById('editTagsInput').value = '';
                    }
                    
                    showEditDeleteResult('success', `âœ… æ¡£æ¡ˆåŠ è½½æˆåŠŸï¼<br><strong>æ¡£æ¡ˆå:</strong> ${item.meta.name || 'æœªå‘½å'}<br><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(item.created_at).toLocaleString()}`);
                } else {
                    showEditDeleteResult('error', 'æ¡£æ¡ˆä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ¡£æ¡ˆå¤±è´¥:', error);
                showEditDeleteResult('error', 'åŠ è½½æ¡£æ¡ˆå¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æ¡£æ¡ˆ
        async function updateItem() {
            const heavenId = document.getElementById('editHeavenId').value.trim();
            const verifyNodeId = document.getElementById('editVerifyNodeId').value.trim();
            const tier = document.getElementById('editTier').value;
            const access = document.getElementById('editAccess').value;
            
            // ä»å„ä¸ªè¾“å…¥å­—æ®µè·å–metaæ•°æ®
            const name = document.getElementById('editNameInput').value.trim();
            const region = document.getElementById('editRegionInput').value.trim();
            const era = document.getElementById('editEraInput').value.trim();
            const tagsText = document.getElementById('editTagsInput').value.trim();

            if (!heavenId) {
                showEditDeleteResult('error', 'è¯·è¾“å…¥æ¡£æ¡ˆID');
                return;
            }

            if (!name) {
                showEditDeleteResult('error', 'è¯·è¾“å…¥å§“å/åç§°');
                return;
            }

            // æ„å»ºmetaå¯¹è±¡
            const meta = {
                name: name,
                region: region || '',
                era: era || ''
            };

            // å¤„ç†æ ‡ç­¾
            if (tagsText) {
                meta.tags = tagsText.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            } else {
                meta.tags = [];
            }

            console.log('Built meta object:', meta);

            try {
                const headers = {};
                if (verifyNodeId) {
                    headers['X-Node-ID'] = verifyNodeId;
                }

                const response = await fetch(`${API_BASE}/api/v1/p2p/items/${heavenId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    body: JSON.stringify({
                        tier: tier,
                        meta: meta,
                        access: access
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showEditDeleteResult('success', `âœ… ${result.message}<br><strong>æ¡£æ¡ˆID:</strong> ${heavenId}<br><strong>ç‰ˆæœ¬:</strong> v${result.data.version}`);
                    // æ¸…ç©ºéªŒè¯èŠ‚ç‚¹IDå­—æ®µ
                    document.getElementById('editVerifyNodeId').value = '';
                    // åˆ·æ–°æ¡£æ¡ˆåˆ—è¡¨
                    getUnifiedItems();
                } else {
                    showEditDeleteResult('error', `âŒ ${result.error}`);
                }
            } catch (error) {
                console.error('æ›´æ–°æ¡£æ¡ˆå¤±è´¥:', error);
                showEditDeleteResult('error', 'æ›´æ–°æ¡£æ¡ˆå¤±è´¥: ' + error.message);
            }
        }

        // é¢„è§ˆè¦åˆ é™¤çš„æ¡£æ¡ˆ
        async function previewDeleteItem() {
            const heavenId = document.getElementById('deleteHeavenId').value.trim();
            
            if (!heavenId) {
                showEditDeleteResult('error', 'è¯·è¾“å…¥è¦é¢„è§ˆçš„æ¡£æ¡ˆID');
                return;
            }

            try {
                const response = await apiCall(`/api/v1/p2p/items/${heavenId}`);
                
                console.log('Preview response:', response);
                
                if (response.success && response.data) {
                    const item = response.data;
                    console.log('Preview item:', item);
                    console.log('Item meta:', item.meta);
                    
                    // å®‰å…¨åœ°è®¿é—®metaå­—æ®µ
                    const meta = item.meta || {};
                    const name = meta.name || 'æœªå‘½å';
                    const tier = item.tier || 'æœªçŸ¥';
                    const nodeId = item.node_id || 'æœªçŸ¥';
                    const createdAt = item.created_at || new Date();
                    const version = item.version || 0;
                    
                    showEditDeleteResult('info', `
                        ğŸ“‹ <strong>æ¡£æ¡ˆé¢„è§ˆ:</strong><br>
                        <strong>æ¡£æ¡ˆID:</strong> ${item.heaven_id || heavenId}<br>
                        <strong>åç§°:</strong> ${name}<br>
                        <strong>ç±»å‹:</strong> ${tier}<br>

                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(createdAt).toLocaleString()}<br>
                        <strong>ç‰ˆæœ¬:</strong> v${version}
                    `);
                } else {
                    showEditDeleteResult('error', `æ¡£æ¡ˆä¸å­˜åœ¨æˆ–é¢„è§ˆå¤±è´¥: ${response.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('é¢„è§ˆæ¡£æ¡ˆå¤±è´¥:', error);
                showEditDeleteResult('error', 'é¢„è§ˆæ¡£æ¡ˆå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤æ¡£æ¡ˆ
        async function deleteItem() {
            const heavenId = document.getElementById('deleteHeavenId').value.trim();
            const verifyNodeId = document.getElementById('deleteVerifyNodeId').value.trim();

            if (!heavenId) {
                showEditDeleteResult('error', 'è¯·è¾“å…¥æ¡£æ¡ˆID');
                return;
            }

            // ç¡®è®¤åˆ é™¤
            if (!confirm(`âš ï¸ ç¡®è®¤åˆ é™¤æ¡£æ¡ˆ ${heavenId}ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const url = new URL(`${API_BASE}/api/v1/p2p/items/${heavenId}`);
                if (verifyNodeId) {
                    url.searchParams.set('node_id', verifyNodeId);
                }

                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const deletedItem = result.deleted_item || result.data || {};
                    const deletedId = deletedItem.heaven_id || heavenId;
                    const deletedAt = deletedItem.deleted_at || new Date();
                    
                    showEditDeleteResult('success', `âœ… ${result.message || 'æ¡£æ¡ˆåˆ é™¤æˆåŠŸ'}<br><strong>åˆ é™¤çš„æ¡£æ¡ˆID:</strong> ${deletedId}<br><strong>åˆ é™¤æ—¶é—´:</strong> ${new Date(deletedAt).toLocaleString()}`);
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('deleteHeavenId').value = '';
                    document.getElementById('deleteVerifyNodeId').value = '';
                    // åˆ·æ–°æ¡£æ¡ˆåˆ—è¡¨
                    getUnifiedItems();
                } else {
                    showEditDeleteResult('error', `âŒ ${result.error || 'åˆ é™¤å¤±è´¥'}`);
                }
            } catch (error) {
                console.error('åˆ é™¤æ¡£æ¡ˆå¤±è´¥:', error);
                showEditDeleteResult('error', 'åˆ é™¤æ¡£æ¡ˆå¤±è´¥: ' + error.message);
            }
        }

        // ä»æ¡£æ¡ˆåˆ—è¡¨å¡«å……ç¼–è¾‘è¡¨å•
        function fillEditForm(heavenId) {
            document.getElementById('editHeavenId').value = heavenId;
            
            // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ»šåŠ¨æ–¹æ³•
            const editTitle = document.getElementById('editArchiveTitle');
            if (editTitle) {
                const titleRect = editTitle.getBoundingClientRect();
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const targetScrollTop = currentScrollTop + titleRect.top - 20; // 20pxçš„é¡¶éƒ¨è¾¹è·
                
                window.scrollTo({
                    top: targetScrollTop,
                    behavior: 'smooth'
                });
            }
            
            // è‡ªåŠ¨åŠ è½½æ¡£æ¡ˆ
            setTimeout(() => loadItemForEdit(), 500);
        }

        // ä»æ¡£æ¡ˆåˆ—è¡¨å¡«å……åˆ é™¤è¡¨å•
        function fillDeleteForm(heavenId) {
            document.getElementById('deleteHeavenId').value = heavenId;
            
            // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ»šåŠ¨æ–¹æ³•
            const deleteTitle = document.getElementById('deleteArchiveTitle');
            if (deleteTitle) {
                const titleRect = deleteTitle.getBoundingClientRect();
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const targetScrollTop = currentScrollTop + titleRect.top - 20; // 20pxçš„é¡¶éƒ¨è¾¹è·
                
                window.scrollTo({
                    top: targetScrollTop,
                    behavior: 'smooth'
                });
            }
            
            // è‡ªåŠ¨é¢„è§ˆæ¡£æ¡ˆ
            setTimeout(() => previewDeleteItem(), 500);
        }

        // æ˜¾ç¤ºç¼–è¾‘åˆ é™¤æ“ä½œç»“æœ
        function showEditDeleteResult(type, message) {
            const resultDiv = document.getElementById('editDeleteResult');
            
            let bgColor, borderColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = '#d4edda';
                    borderColor = '#c3e6cb';
                    textColor = '#155724';
                    icon = 'âœ…';
                    break;
                case 'error':
                    bgColor = '#f8d7da';
                    borderColor = '#f5c6cb';
                    textColor = '#721c24';
                    icon = 'âŒ';
                    break;
                case 'info':
                    bgColor = '#d1ecf1';
                    borderColor = '#bee5eb';
                    textColor = '#0c5460';
                    icon = 'â„¹ï¸';
                    break;
                default:
                    bgColor = '#f8f9fa';
                    borderColor = '#dee2e6';
                    textColor = '#495057';
                    icon = 'ğŸ“‹';
            }

            resultDiv.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; color: ${textColor}; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.2rem;">${icon}</span>
                        <div style="flex: 1; line-height: 1.5;">${message}</div>
                    </div>
                </div>
            `;

            // æ³¨é‡Šæ‰è‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·çš„æ“ä½œæµç¨‹
            // resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¹¶è·å–æ¡£æ¡ˆåˆ—è¡¨
        window.onload = function() {
            console.log('ğŸš€ é¡µé¢å¼€å§‹åŠ è½½...');
            
            // ä½¿ç”¨Promise.allæ¥å¹¶è¡ŒåŠ è½½ï¼Œé¿å…é˜»å¡
            Promise.allSettled([
                checkHealth().catch(error => console.warn('å¥åº·æ£€æŸ¥å¤±è´¥:', error)),
                getUnifiedItems().catch(error => console.warn('æ¡£æ¡ˆåŠ è½½å¤±è´¥:', error)),
                loadCurrentNodeId().catch(error => console.warn('èŠ‚ç‚¹IDåŠ è½½å¤±è´¥:', error))
            ]).then(() => {
                console.log('âœ… ä¸»è¦åŠŸèƒ½åŠ è½½å®Œæˆ');
                
                // ç«‹å³åŠ è½½ç½‘ç»œçŠ¶æ€ï¼Œä¸å†å»¶è¿Ÿ
                console.log('ğŸ”„ ç«‹å³å¼€å§‹åŠ è½½ç½‘ç»œçŠ¶æ€...');
                try {
                    refreshAllNetworkStatus();
                } catch (error) {
                    console.warn('ç½‘ç»œçŠ¶æ€åŠ è½½å¤±è´¥:', error);
                }
            }).catch(error => {
                console.error('é¡µé¢åŠ è½½å¤±è´¥:', error);
            });
        };
    </script>
</body>
</html>

